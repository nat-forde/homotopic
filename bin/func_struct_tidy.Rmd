---
title: "func_struct"
author: "nforde"
date: "March 27, 2018"
output: html_document
---

## get libraries/set paths
```{r}
library(igraph)
library(tidyverse)
library(cowplot)
library(broom)
library(knitr)
library(car)
library(lme4)
library(multcomp)
library(lubridate)
library(zoo)
library(forecast)

outdir <- "/scratch/nforde/homotopic/stats"

#diffusion threshold
dwi_thresh = 5 #percent threshold value, keeps this percent of connections 
FC_thresh = 0.1 # absolute threshold for FC strength

atlas <- "glasser"
xyz <- read.csv("/projects/nforde/atlases/xyz.csv")
##                            ##
##      Glasser               ##
##      1-180 Right           ##
##      181-360 Left          ##

```
## set all the paths/directories & read in data for POND
```{r}
#POND
pond_demographics <- read.csv("/projects/nforde/POND/clinical/POND_06JUN2018_pp.csv")
QCfunc <- read.csv("/projects/nforde/POND/rsMRI/bold.csv")
QCdwi <- read.csv("/projects/nforde/POND/clinical/qc.csv")
QCdwi.class <- read.csv("/projects/nforde/POND/clinical/Classified.csv")
hand <- read.csv("/projects/nforde/POND/clinical/handedness.csv")
SCQ <- read.csv("/projects/nforde/POND/clinical/SCQ_Data_23_July_2018.csv")
WISCV <- read.csv("/projects/nforde/POND/clinical/WISC_5_Data_24_July_2018.csv")
cluster <- read.csv("/projects/nforde/POND/clinical/clust4group_GraceJacobs.csv") #data driven groups from Graces analysis

tsdir <- "/projects/nforde/POND/rsMRI"
diffdir <- "/projects/nforde/POND/CSDnew"
edgedir <- "/projects/nforde/POND/edges"

#merge diff sources of demog and QC data
demogs <- pond_demographics %>% 
  merge(WISCV[c("Subject","WISC_V_FSIQ", "WISC_V_PS")], by.x="SUBJECT", by.y="Subject", all.x=TRUE)

#do some organising and renaming
demogs <- filter(demogs, !is.na(DOB)) %>% filter(!is.na(POND_DATE))
demogs$Age <- interval(ymd(demogs$DOB), ymd(demogs$POND_DATE)) %>% as.duration() %>% as.numeric(unit="years") %>% round(digits=2)
demogs$sex <- demogs$GENDER
demogs$dx <- NA
demogs$dx[demogs$RESEARCH_CONFIRM_DIAG_STD=="1"] <- 'ASD'
demogs$dx[demogs$RESEARCH_CONFIRM_DIAG_STD=="2" | demogs$RESEARCH_CONFIRM_DIAG_STD=="6"] <- 'ADHD'
demogs$dx[demogs$RESEARCH_CONFIRM_DIAG_STD=="3"] <- 'OCD'
demogs$dx[demogs$RESEARCH_CONFIRM_DIAG_STD=="10"] <- 'HC'
demogs$dx[demogs$RESEARCH_CONFIRM_DIAG_STD=="15"] <- 'GAD'
IQ <- data.frame(demogs$WASI_FSIQ_2, demogs$WASI_II_FSIQ_2, demogs$WASI_FSIQ_4, demogs$WASI_II_FSIQ_4, demogs$WISC_IV_FSIQ, demogs$WISC_V_FSIQ)
demogs$FSIQ_any <- apply(IQ, 1, mean, na.rm=TRUE)
demogs$FSIQ_any[demogs$FSIQ_any == "NaN"] <- NA
WISC_PS <- data.frame(demogs$WISC_IV_PS, demogs$WISC_V_PS)
demogs$WISC_PS <- apply(WISC_PS, 1, mean, na.rm=TRUE)
demogs$WISC_PS[demogs$WISC_PS == "NaN"] <- NA
demogs$NDDdx <- NA
demogs$NDDdx[demogs$dx == "ASD" | demogs$dx == "OCD" | demogs$dx == "ADHD"] <- "NDD"
demogs$NDDdx[demogs$dx == "HC"] <- "HC"
  
### reduce the demographic data and merge if other sources
demogs <- demogs[c("SUBJECT","dx", "NDDdx", "Age", "sex", "FSIQ_any", "WISC_PS",  "AB21GCCS", "RBSCPT",
                        "VAB2CP", "OB_SUB", "COM_SUB", "ADHD_I_SUB", "ADHD_HI_SUB", "TPOCS_TOT", "CB68TPTOT", "CB68TPTS")] %>%
  merge(SCQ[c("Subject","SCQTOT")], by.x="SUBJECT", by.y="Subject", all.x=TRUE) %>%
  merge(hand[c("ID","Handed")], by.x="SUBJECT", by.y="ID", all.x=TRUE) %>%
  merge(QCfunc, by.x="SUBJECT", by.y="subject_id") 
demogs$scanner <-NA
demogs$scanner[demogs$spacing_tr!="1.5"] <- 'trio'
demogs$scanner[demogs$spacing_tr=="1.5"] <- 'prisma'

#add 0 infront of 88 subjects
for (i in 1:nrow(demogs)) {
  if (startsWith(as.character(demogs$SUBJECT[i]), "88")) {
    demogs$SUBJECT[i] <- paste0("0", demogs$SUBJECT[i])
  }
}
#add prefix to sub name
demogs$subid <- paste0("sub-",demogs$SUBJECT)

demogs <- unique(demogs)

demogs <- demogs %>% group_by(subid) %>%
  top_n(-1, fd_mean)

QCdwi.class <- QCdwi.class %>% separate(ID, "subid", sep="/") 

demogs <- merge(demogs, QCdwi[c("subject", "shell", "in.ex")], by.x= "subid", by.y = "subject", all.x=TRUE) %>% 
  merge(QCdwi.class[c("subid", "PC1", "cutree.res.hc..k...3.")], by="subid", all.x=TRUE) %>%
  merge(cluster[c("V1","groups_2")], by.x="subid", by.y="V1", all = TRUE)

names(demogs)[names(demogs) == 'groups_2'] <- 'cluster_groups'

```
## set all the paths/directories & read in data for COMPULS
```{r}
#compuls
comp_demogs <- read.csv("/projects/nforde/COMPULS/clinical/phenotype.csv", stringsAsFactors=FALSE)
comp_QCfunc <- read.csv("/projects/nforde/COMPULS/data/bids/derivatives/mriqc/group_bold.tsv", sep = "\t")
comp_QCdwi.class <- read.csv("/projects/nforde/COMPULS/data/dwi_QC/QC_dwi_classified.csv")

comp_tsdir <- "/projects/nforde/COMPULS/data/rsMRI"
comp_diffdir <- "/projects/nforde/COMPULS/data/CSD"
comp_edgedir <- "/projects/nforde/COMPULS/data/edges"

comp_demogs <- comp_demogs %>% rowwise() %>%
  mutate(CBCL_total = sum(Acts.too.young.for.his.her.age, Drinks.alcohol.without.parents.approval, Often.gets.into.arguments, 
                          Does.not.finish.things.he.she.starts.y, There.are.not.many.things.he.she.likes, Poops.outside.of.toilet.or.outside.of.trousers,
                          Brags..acts.tough, Inable.to.concentrate..cannot.focus.on.something.for.very.long, Cannot.get.certain.thoughts.out.of.his.her.head..obsessions,
                          Cannot.sit.still..is.restless.or.hyperactive, Clings.on.to.adults..is.too.dependent, Complains.about.being.lonely, Confused.or.blurred.thoughts, 
                          Cries.often, Cruel.to.animals, Cruel..bullying.or.being.mean.to.others, Daydreaming.or.deep.in.thought, Tries.to.harm.or.kill.himself.herself, 
                          Demands.a.lot.of.attention, Vandalizes.own.stuff, Vandalizes.stuff.of.family.members.or.others, Is.disobedient.at.home, Is.disobedient.at.school,
                          Does.not.eat.well, Cannot.get.along.with.other.boys.or.girls, Does.not.seem.to.feel.guilty.after.misbehaving, Gets.jealous.easily,
                          Does.not.follow.the.rules.at.home..at.school.or.somewhere.else, Is.afraid.of.certain.animals..situations.or.places.other.than.school, 
                          Is.afraid.of.going.to.school, Is.afraid.that.he.she.might.do.or.think.something.bad, Has.the.feeling.that.he.she.has.to.be.perfect,
                          Has.the.feeling.that.or.complains.about.that.no.one.loves.him.her, Has.the.feeling.that.others.are.out.to.get.him.her, Feels.worthless.or.inferior,
                          He.she.often.hurts.himself.herself..or.gets.into.accidents, Fights.often, He.she.is.bullied.often, Spends.time.with.boys.or.girls.who.get.into.trouble,
                          Hears.noises.or.voices.that.are.not.there, Impulsive.or.does.things.without.thinking, Prefers.to.be.alone.instead.of.being.with.others, 
                          Lies.or.deceives, Bites.nails, Nervous.or.tense, nervous.movements.or.twitches, Nightmares, Other.boys.or.girls.do.not.like.him.her, 
                          Suffers.from.constipation, Is.too.anxious.or.scared, Feels.dizzy.or.lightheaded, Feels.very.guilty, Eats.too.much,
                          Feels.tired.without.a.clear.reason, Is.too.fat, Physical.problems.without.known.medical.cause..A..pains, 
                          Physical.problems.without.known.medical.cause..B..headaches, Physical.problems.without.known.medical.cause..C..nausea,
                          Physical.problems.without.known.medical.cause..D..eyeproblems., 
                          Physical.problems.without.known.medical.cause..E..rashes, Physical.problems.without.known.medical.cause..F..stomache.aches,
                          Physical.problems.without.known.medical.cause..G..throwing.up, 
                          Physical.problems.without.known.medical.cause..H..other, 
                          Physically.attacks.others, Picks.nose..skin.or.another.bodypart, Plays.with.own.genitals.in.public, Plays.with.own.genitals.too.often, 
                          Schoolwork.is.of.bad.quality, Clumsy, Prefers.spending.time.with.older.boys.or.girls, Prefers.spending.time.with.younger.boys.or.girls, 
                          Refuses.to.talk, Repeats.certain.actions.over.and.over.again..compulsive.actions, Walks.away.from.home, Shouts.or.screams.often, 
                          Close.tongued..keeps.things.to.herself.himself, Sees.things.that.are.not.there, Is.embarressed.easily.or.feels.uncomfortable, 
                          Starts.fires, Sexual.problems, Shows.off..or.behaves.crazily.to.get.noticed, Too.shy.or.timid, 
                          Sleeps.less.than.other.boys.and.girls, Sleeps.more.than.other.boys.and.girls..during.the.night.or.during.the.day, 
                          Does.not.pay.attention.or.is.easily.distracted, Speech.problems, Has.an.empty.stare, Steals.from.home, 
                          Steals.outside.of.home, Saves.up.a.lot.of.things.he.or.she.does.not.need, Awkward.behaviours, 
                          Awkward.thoughts, Stubborn..sullen.or.irritable, Mood.and.feelings.change.suddenly, Sulks.a.lot, Suspicious, 
                          Swears.or.uses.dirty.words, Talks.about.wanting.to.kill.himself.herself, Sleeptalks.or.sleepwalks,
                          Talks.too.much, Bullies.a.lot, Has.temper.tantrums.or.loses.temper.quickly, Thinks.about.sex.too.much, 
                          Threatens.people, Thumb.sucking, Smokes.tobacco, Sleep.problems, Skips.or.stays.away.from.school, 
                          Not.very.active..moves.slowly.or.has.too.little.energy, Unhappy..sad.or.depressed, Is.louder.than.neccessary,
                          Uses.drugs, Vandalism, Wets.his.her.trousers.during.the.day, Wets.bed, Whines,
                          Wishes.he.or.she.was.of.the.other.sexe, Withdrawn..does.not.associate.with.others, Worries, na.rm=TRUE))
                          
comp_demogs$CBCL_total_Tscore <-NA
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 0 ] <- 24
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 1 & comp_demogs$Age <12] <- 26
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 1 & comp_demogs$Age >12] <- 27
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 2] <- 31
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 3] <- 34
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 4 & comp_demogs$Age <12] <- 36
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 4 & comp_demogs$Age >12] <- 37
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 5] <- 38
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 6 & comp_demogs$Age <12] <- 39
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 6 & comp_demogs$Age >12] <- 40
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 7 & comp_demogs$Age <12] <- 40
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 7 & comp_demogs$Age >12] <- 41
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 8 & comp_demogs$Age <12] <- 41
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 8 & comp_demogs$Age >12] <- 42
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 9 & comp_demogs$Age <12] <- 42
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 9 & comp_demogs$Age >12] <- 43
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 10 & comp_demogs$Age <12] <- 43
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 10 & comp_demogs$Age >12] <- 44
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 11 & comp_demogs$Age <12] <- 44
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 14 & comp_demogs$Age <12] <- 46
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 15 & comp_demogs$Age <12] <- 47
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 16] <- 48
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 19 & comp_demogs$Age >12] <- 50
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 24 & comp_demogs$Age <12] <- 52
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 49 & comp_demogs$Age <12] <- 64
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total == 56 & comp_demogs$Age <12] <- 67

comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 12 & comp_demogs$CBCL_total <= 13 & comp_demogs$Age <12] <- 45
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 17 & comp_demogs$CBCL_total <= 18] <- 49
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 19 & comp_demogs$CBCL_total <= 20 & comp_demogs$Age <12] <- 50
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 21 & comp_demogs$CBCL_total <= 23 & comp_demogs$Age <12] <- 51
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 25 & comp_demogs$CBCL_total <= 27 & comp_demogs$Age <12] <- 53
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 28 & comp_demogs$CBCL_total <= 29 & comp_demogs$Age <12] <- 54
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 30 & comp_demogs$CBCL_total <= 31 & comp_demogs$Age <12] <- 55
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 32 & comp_demogs$CBCL_total <= 33 & comp_demogs$Age <12] <- 56
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 35 & comp_demogs$CBCL_total <= 36 & comp_demogs$Age <12] <- 58
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 37 & comp_demogs$CBCL_total <= 38 & comp_demogs$Age <12] <- 59
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 39 & comp_demogs$CBCL_total <= 40 & comp_demogs$Age <12] <- 60
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 41 & comp_demogs$CBCL_total <= 43 & comp_demogs$Age <12] <- 61
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 44 & comp_demogs$CBCL_total <= 46 & comp_demogs$Age <12] <- 62
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 47 & comp_demogs$CBCL_total <= 48 & comp_demogs$Age <12] <- 63
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 50 & comp_demogs$CBCL_total <= 53 & comp_demogs$Age <12] <- 65
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 54 & comp_demogs$CBCL_total <= 55 & comp_demogs$Age <12] <- 66
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 57 & comp_demogs$CBCL_total <= 58 & comp_demogs$Age <12] <- 68
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 59 & comp_demogs$CBCL_total <= 60 & comp_demogs$Age <12] <- 69
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 61 & comp_demogs$CBCL_total <= 65 & comp_demogs$Age <12] <- 70
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 66 & comp_demogs$CBCL_total <= 71 & comp_demogs$Age <12] <- 71
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 72 & comp_demogs$CBCL_total <= 77 & comp_demogs$Age <12] <- 72
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 78 & comp_demogs$CBCL_total <= 83 & comp_demogs$Age <12] <- 73
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 84 & comp_demogs$CBCL_total <= 89 & comp_demogs$Age <12] <- 74
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 90 & comp_demogs$CBCL_total <= 95 & comp_demogs$Age <12] <- 75
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 96 & comp_demogs$CBCL_total <= 101 & comp_demogs$Age <12] <- 76
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 102 & comp_demogs$CBCL_total <= 107 & comp_demogs$Age <12] <- 77
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 108 & comp_demogs$CBCL_total <= 113 & comp_demogs$Age <12] <- 78
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 114 & comp_demogs$CBCL_total <= 120 & comp_demogs$Age <12] <- 79
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 121 & comp_demogs$CBCL_total <= 126 & comp_demogs$Age <12] <- 80

comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 11 & comp_demogs$CBCL_total <= 12 & comp_demogs$Age >12] <- 45
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 14 & comp_demogs$CBCL_total <= 15 & comp_demogs$Age >12] <- 47
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 20 & comp_demogs$CBCL_total <= 21 & comp_demogs$Age >12] <- 51
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 22 & comp_demogs$CBCL_total <= 23 & comp_demogs$Age >12] <- 52
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 24 & comp_demogs$CBCL_total <= 25 & comp_demogs$Age >12] <- 53
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 26 & comp_demogs$CBCL_total <= 27 & comp_demogs$Age >12] <- 54
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 28 & comp_demogs$CBCL_total <= 29 & comp_demogs$Age >12] <- 55
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 30 & comp_demogs$CBCL_total <= 32 & comp_demogs$Age >12] <- 56
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 33 & comp_demogs$CBCL_total <= 34 & comp_demogs$Age >12] <- 57
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 35 & comp_demogs$CBCL_total <= 37 & comp_demogs$Age >12] <- 58
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 38 & comp_demogs$CBCL_total <= 39 & comp_demogs$Age >12] <- 59
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 40 & comp_demogs$CBCL_total <= 43 & comp_demogs$Age >12] <- 60
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 44 & comp_demogs$CBCL_total <= 46 & comp_demogs$Age >12] <- 61
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 47 & comp_demogs$CBCL_total <= 48 & comp_demogs$Age >12] <- 62
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 49 & comp_demogs$CBCL_total <= 51 & comp_demogs$Age >12] <- 63
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 52 & comp_demogs$CBCL_total <= 57 & comp_demogs$Age >12] <- 64
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 58 & comp_demogs$CBCL_total <= 60 & comp_demogs$Age >12] <- 65
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 61 & comp_demogs$CBCL_total <= 63 & comp_demogs$Age >12] <- 66
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 64 & comp_demogs$CBCL_total <= 65 & comp_demogs$Age >12] <- 67
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 66 & comp_demogs$CBCL_total <= 67 & comp_demogs$Age >12] <- 68
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 68 & comp_demogs$CBCL_total <= 70 & comp_demogs$Age >12] <- 69
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 71 & comp_demogs$CBCL_total <= 77 & comp_demogs$Age >12] <- 70
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 78 & comp_demogs$CBCL_total <= 82 & comp_demogs$Age >12] <- 71
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 83 & comp_demogs$CBCL_total <= 86 & comp_demogs$Age >12] <- 72
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 87 & comp_demogs$CBCL_total <= 91 & comp_demogs$Age >12] <- 73
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 92 & comp_demogs$CBCL_total <= 96 & comp_demogs$Age >12] <- 74
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 97 & comp_demogs$CBCL_total <= 101 & comp_demogs$Age >12] <- 75
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 102 & comp_demogs$CBCL_total <= 105 & comp_demogs$Age >12] <- 76
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 106 & comp_demogs$CBCL_total <= 110 & comp_demogs$Age >12] <- 77
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 111 & comp_demogs$CBCL_total <= 115 & comp_demogs$Age >12] <- 78
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 116 & comp_demogs$CBCL_total <= 120 & comp_demogs$Age >12] <- 79
comp_demogs$CBCL_total_Tscore[comp_demogs$CBCL_total >= 121 & comp_demogs$CBCL_total <= 124 & comp_demogs$Age >12] <- 80


comp_demogs <- comp_demogs %>% mutate(Age = round(Age, digits=2))
comp_demogs$Sex <- NA
comp_demogs$Sex[comp_demogs$sex=="male"] <- 'Male'
comp_demogs$Sex[comp_demogs$sex=="female"] <- 'Female'

comp_demogs$dx <- NA
comp_demogs$dx[comp_demogs$Diagnosis=="1"] <- 'HC'
comp_demogs$dx[comp_demogs$Diagnosis=="2"] <- 'OCD' 
comp_demogs$dx[comp_demogs$Diagnosis=="3"] <- 'ASD' 
comp_demogs$dx[comp_demogs$Diagnosis=="4"] <- 'ADHD'
comp_demogs$dx[comp_demogs$Diagnosis=="5"] <- 'TS'

#func QC data is separate for each echo (MRIQC output) so need to average across echoes 
comp_QCfunc <- comp_QCfunc %>% separate(bids_name, c("subid", "task", "echo"), sep="_") %>%
  group_by(subid) %>% summarise_all(funs(mean))

#comp_QCdwi.class <- comp_QCdwi.class %>% separate(ID, "subid", sep="/") 

### reduce the demographic data and merge if other sources
comp_demogs <- merge(comp_QCdwi.class[c("subject_id", "Comp.1", "Comp.2", "QC_clust", "exclude")], 
                     comp_demogs[c("Subject.details","dx", "Age", "Sex", "Estimated.IQ..Total.IQ", "CBCL_total", "CBCL_total_Tscore")], by.x="subject_id", by.y="Subject.details", all=TRUE) %>%
  merge(comp_QCfunc[c("subid", "dvars_nstd", "fd_mean", "size_t", "tsnr")], by.x="subject_id", by.y="subid", all=TRUE)

names(comp_demogs)[names(comp_demogs) == 'Sex'] <- 'sex'
names(comp_demogs)[names(comp_demogs) == 'Estimated.IQ..Total.IQ'] <- 'IQ'
names(comp_demogs)[names(comp_demogs) == 'subject_id'] <- 'subid'
```

#define functions
```{r}

## for normalising data
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

## to make dataframe that labels connection as I, HE and HO
make_g_template <- function(subid, tsdir) {

  if (atlas == "glasser") {
    meants <- read.csv(file.path(tsdir, subid, paste(atlas, "meants.csv", sep="_")), header=FALSE)  
    roiids <- read.csv(file.path(tsdir, subid, paste(atlas, "roiids.csv", sep="_")), header=TRUE)  

    rois <- as.character(roiids$labelname)
    meants_t <- t(meants)
    colnames(meants_t) <- rois
  
    cormat <- cor(meants_t)
    g<-graph_from_adjacency_matrix(cormat,mode="upper", 
                                 weighted=T, diag=F, 
                                 add.rownames = "code")
    g.df <- as.data.frame(get.edgelist(g), names=T)
  
    for (i in 1:nrow(g.df)) {
      g.df$V1.hemi[i] = strsplit(as.character(g.df$V1[i]),"_")[[1]][1]
      g.df$V1.roi[i] = strsplit(as.character(g.df$V1[i]),"_")[[1]][2]
      g.df$V2.hemi[i] = strsplit(as.character(g.df$V2[i]),"_")[[1]][1]
      g.df$V2.roi[i] = strsplit(as.character(g.df$V2[i]),"_")[[1]][2]
    } 
    g.df$FCtype <- NA
    g.df$FCtype[g.df$V1.roi==g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Homotopic"
    g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Heterotopic"
    g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi==g.df$V2.hemi] <- "Intrahemispheric"
    
    V1xyz <- xyz
    V1names <- c("V1x", "V1y", "V1z", "V1roi")
    colnames(V1xyz) <- V1names
    V2xyz <- xyz
    V2names <- c("V2x", "V2y", "V2z", "V2roi")
    colnames(V2xyz) <- V2names

    tmpV1 <- merge(g.df, V1xyz, by.x="V1", by.y="V1roi")
    g.df <- merge(tmpV1, V2xyz, by.x="V2", by.y="V2roi")
    
  } else if (atlas == "DK")  {
    meants <- read.csv(file.path(tsdir, subid, paste(atlas, "meants.csv", sep="_")), header=FALSE)  
    roiids <- read.csv(file.path(tsdir, subid, paste(atlas, "roiids.csv", sep="_")), header=FALSE)  
 
    rois <- as.character(roiids$V1)
    
    meants_t <- as.data.frame(t(meants))
    colnames(meants_t) <- rois
    
    cormat <- cor(meants_t)
    g<-graph_from_adjacency_matrix(cormat,mode="upper",
                                 weighted=T, diag=F,
                                 add.rownames = "code")
    g.df0 <- as.data.frame(get.edgelist(g), names=T)
    
    FStable <- read.table("/scratch/nforde/homotopic/bin/FreeSurferColorLUT.txt", header=TRUE) 
    FStable$labelname <- sub("ctx_", "", FStable$labelname)
    FStable$labelname <- sub("-", "_", FStable$labelname)
  
    g.df <- g.df0 %>%  merge(FStable[c("Index", "labelname")], by.x= "V1", by.y = "Index") %>%
      merge(FStable[c("Index", "labelname")], by.x= "V2", by.y = "Index") 
    colnames(g.df) <- c("V2", "V1", "ROI1", "ROI2")
   
    #filter to keep only rois of interest when assigning FCtype
    g.df <- g.df %>% 
       filter(!str_detect(ROI1, '3rd|4th|Lat-Vent|Optic|Ventricle|Cerebral|White|vessel|unknown|choroid|Brain|CC|WM|CSF|Cerebellum')) %>% 
       filter(!str_detect(ROI2, '3rd|4th|Lat-Vent|Optic|Ventricle|Cerebral|White|vessel|unknown|choroid|Brain|CC|WM|CSF|Cerebellum'))
    
    for (i in 1:nrow(g.df)) {
      g.df$V1.hemi[i] = strsplit(as.character(g.df$ROI1[i]),"_")[[1]][1]
      g.df$V2.hemi[i] = strsplit(as.character(g.df$ROI2[i]),"_")[[1]][1]
      
      g.df$V1.roi[i] = paste(strsplit(as.character(g.df$ROI1[i]),"_")[[1]][-1], collapse = "")
      g.df$V2.roi[i] = paste(strsplit(as.character(g.df$ROI2[i]),"_")[[1]][-1], collapse = "")
    }
    
    g.df$FCtype <- NA
    g.df$FCtype[g.df$V1.roi==g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Homotopic"
    g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Heterotopic"
    g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi==g.df$V2.hemi] <- "Intrahemispheric"

    # Merge back with g.df0 so all ROI combinations are present
    g.df <- merge(g.df0, g.df, by=c("V1", "V2"), all=TRUE)
  }
  return(g.df)
}


## to calculate FC strength (Z-scores), temmp stabiulity and structural connection weight
calc_everything <- function(subids, tsdir , g.df, diffdir, FC_thresh, dwi_thresh, edgedir) {
  ###########  set up empty dataframes ##################
  theZs <- data.frame("subid" = subids, 
                      "HO" = numeric(length(subids)),
                      "HE" = numeric(length(subids)),
                      "I" = numeric(length(subids)),
                      "lenNA" = numeric(length(subids)),
                      "len1" = numeric(length(subids)),
                      "len2" = numeric(length(subids)),
                      "len3" = numeric(length(subids)),
                      "len4" = numeric(length(subids)),
                      "len5" = numeric(length(subids)),
                      "len6" = numeric(length(subids)),
                      "len7" = numeric(length(subids)),
                      "len8" = numeric(length(subids)),
                      "len9" = numeric(length(subids)),
                      "len10" = numeric(length(subids)),
                      "dwNA" = numeric(length(subids)),
                      "dw1" = numeric(length(subids)),
                      "dw2" = numeric(length(subids)),
                      "dw3" = numeric(length(subids)),
                      "dw4" = numeric(length(subids)),
                      "dw5" = numeric(length(subids)),
                      "dw6" = numeric(length(subids)),
                      "dw7" = numeric(length(subids)),
                      "dw8" = numeric(length(subids)),
                      "dw9" = numeric(length(subids)),
                      "dw10" = numeric(length(subids)))

  theZs[ ,2:ncol(theZs)] <- numeric(nrow(theZs)*(ncol(theZs)-1))
  
  theDW <- theZs
  
  ## loop for each subject
  for (i in 1:nrow(theZs)) {
    ################ FC strength ###########################
    ## get the subid from the dataframe and read in the meants
    subid <- theZs$subid[i]
    meants.file <- file.path(tsdir, subid, paste(atlas, "meants.csv", sep="_"))
    out.file <- file.path(edgedir, paste(subid, atlas, "edge_metrics.csv", sep="_"))
    
    # if (file.exists(out.file)){
    #   edges.all <- read.csv(out.file, header =TRUE)
    #   edges.dw_nonzero <- subset(edges.all)
    #   theZs$HO[i] <- mean(filter(edges.all, FCtype == "Homotopic")$theseZ, na.rm=TRUE)
    #   theZs$HE[i] <- mean(filter(edges.all, FCtype == "Heterotopic")$theseZ, na.rm=TRUE)
    #   theZs$I[i] <- mean(filter(edges.all, FCtype == "Intrahemispheric")$theseZ, na.rm=TRUE)
    #   theZs$lenNA[i] <- mean(filter(edges.all, is.na(len_quant))$theseZ, na.rm=TRUE)
    #   theZs$len1[i] <- mean(filter(edges.all, len_quant == "1")$theseZ, na.rm=TRUE)
    #   theZs$len2[i] <- mean(filter(edges.all, len_quant == "2")$theseZ, na.rm=TRUE)
    #   theZs$len3[i] <- mean(filter(edges.all, len_quant == "3")$theseZ, na.rm=TRUE)
    #   theZs$len4[i] <- mean(filter(edges.all, len_quant == "4")$theseZ, na.rm=TRUE)
    #   theZs$len5[i] <- mean(filter(edges.all, len_quant == "5")$theseZ, na.rm=TRUE)
    #   theZs$len6[i] <- mean(filter(edges.all, len_quant == "6")$theseZ, na.rm=TRUE)
    #   theZs$len7[i] <- mean(filter(edges.all, len_quant == "7")$theseZ, na.rm=TRUE)
    #   theZs$len8[i] <- mean(filter(edges.all, len_quant == "8")$theseZ, na.rm=TRUE)
    #   theZs$len9[i] <- mean(filter(edges.all, len_quant == "9")$theseZ, na.rm=TRUE)
    #   theZs$len10[i] <- mean(filter(edges.all, len_quant == "10")$theseZ, na.rm=TRUE)
    # 
    #   theZs$dwNA[i] <- mean(filter(edges.all, is.na(dw_quant))$theseZ, na.rm=TRUE)
    #   theZs$dw1[i] <- mean(filter(edges.all, dw_quant == "1")$theseZ, na.rm=TRUE)
    #   theZs$dw2[i] <- mean(filter(edges.all, dw_quant == "2")$theseZ, na.rm=TRUE)
    #   theZs$dw3[i] <- mean(filter(edges.all, dw_quant == "3")$theseZ, na.rm=TRUE)
    #   theZs$dw4[i] <- mean(filter(edges.all, dw_quant == "4")$theseZ, na.rm=TRUE)
    #   theZs$dw5[i] <- mean(filter(edges.all, dw_quant == "5")$theseZ, na.rm=TRUE)
    #   theZs$dw6[i] <- mean(filter(edges.all, dw_quant == "6")$theseZ, na.rm=TRUE)
    #   theZs$dw7[i] <- mean(filter(edges.all, dw_quant == "7")$theseZ, na.rm=TRUE)
    #   theZs$dw8[i] <- mean(filter(edges.all, dw_quant == "8")$theseZ, na.rm=TRUE)
    #   theZs$dw9[i] <- mean(filter(edges.all, dw_quant == "9")$theseZ, na.rm=TRUE)
    #   theZs$dw10[i] <- mean(filter(edges.all, dw_quant == "10")$theseZ, na.rm=TRUE)
    # 
    #   theDW$HO[i] <- mean(filter(edges.dw_nonzero, FCtype == "Homotopic")$raw, na.rm=TRUE)  ######### get very low numbers if edges.all used
    #   theDW$HE[i] <- mean(filter(edges.dw_nonzero, FCtype == "Heterotopic")$raw, na.rm=TRUE)
    #   theDW$I[i] <- mean(filter(edges.dw_nonzero, FCtype == "Intrahemispheric")$raw, na.rm=TRUE)
    #   theDW$lenNA[i] <- mean(filter(edges.dw_nonzero, is.na(len_quant))$raw)
    #   theDW$len1[i] <- mean(filter(edges.dw_nonzero, len_quant == "1")$raw)
    #   theDW$len2[i] <- mean(filter(edges.dw_nonzero, len_quant == "2")$raw)
    #   theDW$len3[i] <- mean(filter(edges.dw_nonzero, len_quant == "3")$raw)
    #   theDW$len4[i] <- mean(filter(edges.dw_nonzero, len_quant == "4")$raw)
    #   theDW$len5[i] <- mean(filter(edges.dw_nonzero, len_quant == "5")$raw)
    #   theDW$len6[i] <- mean(filter(edges.dw_nonzero, len_quant == "6")$raw)
    #   theDW$len7[i] <- mean(filter(edges.dw_nonzero, len_quant == "7")$raw)
    #   theDW$len8[i] <- mean(filter(edges.dw_nonzero, len_quant == "8")$raw)
    #   theDW$len9[i] <- mean(filter(edges.dw_nonzero, len_quant == "9")$raw)
    #   theDW$len10[i] <- mean(filter(edges.dw_nonzero, len_quant == "10")$raw)
    # 
    #   theDW$dwNA[i] <- mean(filter(edges.dw_nonzero, is.na(dw_quant))$raw)
    #   theDW$dw1[i] <- mean(filter(edges.dw_nonzero, dw_quant == "1")$raw)
    #   theDW$dw2[i] <- mean(filter(edges.dw_nonzero, dw_quant == "2")$raw)
    #   theDW$dw3[i] <- mean(filter(edges.dw_nonzero, dw_quant == "3")$raw)
    #   theDW$dw4[i] <- mean(filter(edges.dw_nonzero, dw_quant == "4")$raw)
    #   theDW$dw5[i] <- mean(filter(edges.dw_nonzero, dw_quant == "5")$raw)
    #   theDW$dw6[i] <- mean(filter(edges.dw_nonzero, dw_quant == "6")$raw)
    #   theDW$dw7[i] <- mean(filter(edges.dw_nonzero, dw_quant == "7")$raw)
    #   theDW$dw8[i] <- mean(filter(edges.dw_nonzero, dw_quant == "8")$raw)
    #   theDW$dw9[i] <- mean(filter(edges.dw_nonzero, dw_quant == "9")$raw)
    #   theDW$dw10[i] <- mean(filter(edges.dw_nonzero, dw_quant == "10")$raw)
    # 
    # } else {
    
    if (file.exists(meants.file)) {
      meants <- read.csv(meants.file,header=FALSE)  
      
      if (atlas == "glasser" | atlas == "ColeAnti") {
        roiids <- read.csv(file.path(tsdir, subid, paste(atlas, "roiids.csv", sep="_")), header=TRUE)
        rois <- as.character(roiids$labelname)
      } else if (atlas == "DK")  {
        roiids <- read.csv(file.path(tsdir, subid, paste(atlas, "roiids.csv", sep="_")), header=FALSE) 
        rois <- as.character(roiids$V1)
      }
      
      names(meants) <- paste0("TR_",1:ncol(meants))
      ## correlate and graph
      cormat <- cor(t(dplyr::select(meants,starts_with("TR_"))))
      g <-graph_from_adjacency_matrix(cormat,mode="upper", weighted=TRUE, diag=FALSE)
      V(g)$name <- rois
      # take the egde list as a vector
      thecorrs <- E(g)$weight
      edge.namesZ <- as.data.frame(as_edgelist(g, names=TRUE))
      edge.namesZ$thecorrs <- thecorrs
      edges.Z <- merge(g.df, edge.namesZ, by=c("V1","V2"))
      
      edges.Z$theseZ <- edges.Z$thecorrs
      edges.Z$theseZ[edges.Z$theseZ < 0.1] <- 'NA' ###threshold for functional connectivity matrix. Note: removes all neg correlations
      edges.Z$theseZ <- as.numeric(edges.Z$theseZ)
     
      ########## get lots of NAs with DK....
      
      ################ DWI connectivity ###########################                    
      diff.file <- file.path(diffdir, subid, paste0("prob_", atlas, ".csv"))
      len.file <- file.path(diffdir, subid, paste0("prob_length_", atlas, ".csv"))
      #vox.file <- file.path(diffdir, subid, paste0("voxel_count_", atlas,".txt"))                    
      if (file.exists(diff.file)) {
        diff <- read.csv(diff.file, sep="", header=FALSE) 
        
        if (atlas == "glasser"| atlas == "ColeAnti"){
          colnames(diff) <- rois #########for DK atlas this will be different
          rownames(diff) <- rois
        } else if (atlas == "DK") {
          diffrois <- as.character(seq(1:length(diff)))
          colnames(diff) <- diffrois 
          rownames(diff) <- diffrois
          diff <- diff[rois, rois]  
        }
        
        #can't have 0's for igraph : +1, make graph merge and then -1
        diffplus1 <-diff +1
        diff_g<-graph_from_adjacency_matrix(as.matrix(diffplus1),mode="upper", 
                                            weighted=TRUE, diag=FALSE, add.colnames=TRUE) 
        V(diff_g)$name <- rois
        
        # take the egde list as a vector
        rawplus1 <- E(diff_g)$weight
        raw <- rawplus1 -1
        
        edge.namesDW <- as.data.frame(as_edgelist(diff_g, names=TRUE))
        
        edge.namesDW$raw <- raw
        edges.dw <- merge(g.df, edge.namesDW, by=c("V1","V2"), all.x=TRUE)
        
       # #normalise for number of voxels 
       #  vox <- read.table(vox.file, sep="", header=FALSE)
       #  oddvals <- seq(1, ncol(vox), by=2)
       #  vox_count <- vox[,oddvals] #select voxel number and exclude volume
       #  t.vox <- t(vox_count)
       #  
       #  if (atlas == "glasser" | atlas == "ColeAnti"){
       #    voxels <- data.frame(t.vox, rois)
       #    
       #  } else if (atlas == "DK") {
       #    voxels <- data.frame(t.vox, diffrois)
       #    rownames(voxels) <- diffrois
       #    voxels <- voxels[rois, ]  
       #  }
       #  
       #  colnames(voxels) <- c('vox', 'rois')
       #  edges <- edges.dw[c('V1','V2')]
       #  V1.vox <- merge(edges, voxels, by.x='V1', by.y='rois')
       #  V2.vox <- merge(edges, voxels, by.x='V2', by.y='rois')
       #  V1.V2 <- merge(V1.vox, V2.vox, by=c('V1', 'V2'))
       #  V1.V2$vox.total <- as.numeric(V1.V2$vox.x) + as.numeric(V1.V2$vox.y)
       #  edges.dw <- merge(edges.dw, V1.V2[c('V1', 'V2', 'vox.total')], by=c('V1', 'V2'))
       #  if (atlas == "glasser"){
       #    edges.dw$weight <- edges.dw$raw / edges.dw$vox.total * (sum(edges.dw$vox.total)/64620)
       #  } else if (atlas == "ColeAnti"){
       #    edges.dw$weight <- edges.dw$raw / edges.dw$vox.total * (sum(edges.dw$vox.total)/64620) #### check numbers
       #  } else if (atlas == "DK") {
       #    SumVox <- sum(filter(edges.dw, FCtype == "Intrahemispheric" | FCtype == "Homotopic" | FCtype == "Heterotopic")$vox.total)
       #    SumROI <- nrow(filter(edges.dw, FCtype == "Intrahemispheric" | FCtype == "Homotopic" | FCtype == "Heterotopic"))
       #    edges.dw$weight <- edges.dw$raw / edges.dw$vox.total * (SumVox)/SumROI #### check numbers
       #  }
        
        #length connectome
        len <- read.csv(len.file, sep="", header=FALSE)
        
        if (atlas == "glasser"| atlas == "ColeAnti"){
          colnames(len) <- rois
        } else if (atlas == "DK") {
          colnames(len) <- diffrois 
          rownames(len) <- diffrois
          len <- len[rois, rois]  
        }
        
        #can't have 0's for igraph : +1, make graph merge and then -1
        lenplus1 <-len +1
        len_g<-graph_from_adjacency_matrix(as.matrix(lenplus1),mode="upper", 
                                           weighted=TRUE, diag=FALSE, add.colnames=TRUE) 
        V(len_g)$name <- rois
    
        #take the egde list as a vector
        lenplus1 <- E(len_g)$weight
        length <- lenplus1 -1
        len.df <- as.data.frame(as_edgelist(len_g, names=TRUE))
        len.df$length <- length
        edges.dw <- merge(edges.dw, len.df, by=c('V1', 'V2'), all.x=TRUE)
        
        #select nonzero length connections and bin by i) length and ii) edge weight 
        # first threshold by connection weight to remove spurious connections .....%
        edges.dw_nonzero <- filter(edges.dw, raw > quantile(raw, prob = 1 - dwi_thresh/100))
        #edges.dw_nonzero <- filter(edges.dw, length > 4 & raw >5)
        edges.dw_nonzero <- within(edges.dw_nonzero, len_quant <- as.integer(cut(length, quantile(length, probs=0:10/10), include.lowest=TRUE)))
        edges.dw_nonzero <- within(edges.dw_nonzero, dw_quant <- as.integer(cut(raw, quantile(raw, probs=0:10/10), include.lowest=TRUE)))
        
        #can merge to get full edge list again
        edges.dw_all <- merge(edges.dw, edges.dw_nonzero[c('V1', 'V2', 'len_quant', 'dw_quant')], by=c('V1', 'V2'), all.x=TRUE)
        edges.all <- merge(edges.Z[c("V1", "V2", "theseZ")], edges.dw_all, by=c('V1', 'V2'), all=TRUE)
        out.file <- file.path(edgedir, paste(subid, atlas, "edge_metrics.csv", sep="_"))
        write.csv(edges.all, out.file, row.names = F)
      
        theZs$HO[i] <- mean(filter(edges.all, FCtype == "Homotopic")$theseZ, na.rm=TRUE)
        theZs$HE[i] <- mean(filter(edges.all, FCtype == "Heterotopic")$theseZ, na.rm=TRUE)
        theZs$I[i] <- mean(filter(edges.all, FCtype == "Intrahemispheric")$theseZ, na.rm=TRUE)
        theZs$lenNA[i] <- mean(filter(edges.all, is.na(len_quant))$theseZ, na.rm=TRUE)
        theZs$len1[i] <- mean(filter(edges.all, len_quant == "1")$theseZ, na.rm=TRUE)
        theZs$len2[i] <- mean(filter(edges.all, len_quant == "2")$theseZ, na.rm=TRUE)
        theZs$len3[i] <- mean(filter(edges.all, len_quant == "3")$theseZ, na.rm=TRUE)
        theZs$len4[i] <- mean(filter(edges.all, len_quant == "4")$theseZ, na.rm=TRUE)
        theZs$len5[i] <- mean(filter(edges.all, len_quant == "5")$theseZ, na.rm=TRUE)
        theZs$len6[i] <- mean(filter(edges.all, len_quant == "6")$theseZ, na.rm=TRUE)
        theZs$len7[i] <- mean(filter(edges.all, len_quant == "7")$theseZ, na.rm=TRUE)
        theZs$len8[i] <- mean(filter(edges.all, len_quant == "8")$theseZ, na.rm=TRUE)
        theZs$len9[i] <- mean(filter(edges.all, len_quant == "9")$theseZ, na.rm=TRUE)
        theZs$len10[i] <- mean(filter(edges.all, len_quant == "10")$theseZ, na.rm=TRUE)
        
        theZs$dwNA[i] <- mean(filter(edges.all, is.na(dw_quant))$theseZ, na.rm=TRUE)
        theZs$dw1[i] <- mean(filter(edges.all, dw_quant == "1")$theseZ, na.rm=TRUE)
        theZs$dw2[i] <- mean(filter(edges.all, dw_quant == "2")$theseZ, na.rm=TRUE)
        theZs$dw3[i] <- mean(filter(edges.all, dw_quant == "3")$theseZ, na.rm=TRUE)
        theZs$dw4[i] <- mean(filter(edges.all, dw_quant == "4")$theseZ, na.rm=TRUE)
        theZs$dw5[i] <- mean(filter(edges.all, dw_quant == "5")$theseZ, na.rm=TRUE)
        theZs$dw6[i] <- mean(filter(edges.all, dw_quant == "6")$theseZ, na.rm=TRUE)
        theZs$dw7[i] <- mean(filter(edges.all, dw_quant == "7")$theseZ, na.rm=TRUE)
        theZs$dw8[i] <- mean(filter(edges.all, dw_quant == "8")$theseZ, na.rm=TRUE)
        theZs$dw9[i] <- mean(filter(edges.all, dw_quant == "9")$theseZ, na.rm=TRUE)
        theZs$dw10[i] <- mean(filter(edges.all, dw_quant == "10")$theseZ, na.rm=TRUE)
        
        theDW$HO[i] <- mean(filter(edges.dw_nonzero, FCtype == "Homotopic")$raw, na.rm=TRUE)  ######### get very low numbers if edges.all used
        theDW$HE[i] <- mean(filter(edges.dw_nonzero, FCtype == "Heterotopic")$raw, na.rm=TRUE)
        theDW$I[i] <- mean(filter(edges.dw_nonzero, FCtype == "Intrahemispheric")$raw, na.rm=TRUE)
        theDW$lenNA[i] <- mean(filter(edges.dw_nonzero, is.na(len_quant))$raw)
        theDW$len1[i] <- mean(filter(edges.dw_nonzero, len_quant == "1")$raw)
        theDW$len2[i] <- mean(filter(edges.dw_nonzero, len_quant == "2")$raw)
        theDW$len3[i] <- mean(filter(edges.dw_nonzero, len_quant == "3")$raw)
        theDW$len4[i] <- mean(filter(edges.dw_nonzero, len_quant == "4")$raw)
        theDW$len5[i] <- mean(filter(edges.dw_nonzero, len_quant == "5")$raw)
        theDW$len6[i] <- mean(filter(edges.dw_nonzero, len_quant == "6")$raw)
        theDW$len7[i] <- mean(filter(edges.dw_nonzero, len_quant == "7")$raw)
        theDW$len8[i] <- mean(filter(edges.dw_nonzero, len_quant == "8")$raw)
        theDW$len9[i] <- mean(filter(edges.dw_nonzero, len_quant == "9")$raw)
        theDW$len10[i] <- mean(filter(edges.dw_nonzero, len_quant == "10")$raw)

        theDW$dwNA[i] <- mean(filter(edges.dw_nonzero, is.na(dw_quant))$raw)
        theDW$dw1[i] <- mean(filter(edges.dw_nonzero, dw_quant == "1")$raw)
        theDW$dw2[i] <- mean(filter(edges.dw_nonzero, dw_quant == "2")$raw)
        theDW$dw3[i] <- mean(filter(edges.dw_nonzero, dw_quant == "3")$raw)
        theDW$dw4[i] <- mean(filter(edges.dw_nonzero, dw_quant == "4")$raw)
        theDW$dw5[i] <- mean(filter(edges.dw_nonzero, dw_quant == "5")$raw)
        theDW$dw6[i] <- mean(filter(edges.dw_nonzero, dw_quant == "6")$raw)
        theDW$dw7[i] <- mean(filter(edges.dw_nonzero, dw_quant == "7")$raw)
        theDW$dw8[i] <- mean(filter(edges.dw_nonzero, dw_quant == "8")$raw)
        theDW$dw9[i] <- mean(filter(edges.dw_nonzero, dw_quant == "9")$raw)
        theDW$dw10[i] <- mean(filter(edges.dw_nonzero, dw_quant == "10")$raw)
      
      } else {
          print(paste(diff.file, "does not exist"))
          theZs[i,5:ncol(theZs)] <- NA
          theDW[i,2:ncol(theDW)] <- NA
        
          theZs$HO[i] <- mean(filter(edges.Z, FCtype == "Homotopic")$theseZ, na.rm=TRUE)
          theZs$HE[i] <- mean(filter(edges.Z, FCtype == "Heterotopic")$theseZ, na.rm=TRUE)
          theZs$I[i] <- mean(filter(edges.Z, FCtype == "Intrahemispheric")$theseZ, na.rm=TRUE)
          
      }
    } else {
       print(paste(meants.file, "does not exist"))
       theZs[i,2:ncol(theZs)] <- NA
       
    }
    
  }
  return(list("theZs"=theZs,"theDW"=theDW))
}
  
```
## Run POND
```{r}
# filter to get rid of bad QC
demogs <- demogs %>% filter(fd_mean < 0.4) %>% filter(size_t > 100) ### dwi data filtered in analyses

subids <- demogs$subid

g.df <- make_g_template(subids[1], tsdir)

pond_metrics <- calc_everything(subids, tsdir, g.df, diffdir, FC_thresh, dwi_thresh, edgedir)

theZs <- pond_metrics$theZs
theDW <- pond_metrics$theDW

```

## Run COMPULS
```{r}
# filter to get rid of bad QC
comp_demogs <- comp_demogs %>% filter(fd_mean < 0.4) %>% filter(size_t > 200) ### dwi data filtered in analyses

comp_subids <- comp_demogs$subid

comp_metrics <- calc_everything(comp_subids, comp_tsdir, g.df, comp_diffdir, FC_thresh, dwi_thresh, comp_edgedir)

comp_theZs <- comp_metrics$theZs
comp_theDW <- comp_metrics$theDW

```

## Sort data POND
```{r, fig.width=12}

typeZ <- theZs %>%
   gather(FCtype, Z, HO, HE, I) %>%
   filter(!is.na(Z))
  
typeDW <- theDW %>%
   gather(FCtype, DW, HO, HE, I)

type <- demogs %>%
  merge(typeZ[c("subid","FCtype","Z")], by="subid") %>%
  merge(typeDW[c("subid","FCtype","DW")], by=c("subid","FCtype"), all.x =TRUE) %>%
  filter(Age > 6, Age <= 18, dx != "GAD", !is.na(dx))

type_trio <- subset(type, scanner =="trio" & shell == "single")
type_prisma <- subset(type, scanner =="prisma")

lenQZ <- theZs %>% 
  gather(lenQ, Z, starts_with("len")) %>%
  filter(!is.na(Z))
 
lenQDW <- theDW %>%
   gather(lenQ, DW, starts_with("len")) 

lenQ <- demogs %>%
  merge(lenQZ[c("subid","lenQ","Z")], by="subid") %>%
  merge(lenQDW[c("subid","lenQ","DW")], by=c("subid","lenQ"), all.x =TRUE) %>%
  filter(Age > 6, dx != "GAD", !is.na(dx))

lenQ_trio <- subset(lenQ, scanner =="trio" & shell == "single")

dwQZ <- theZs %>%
   gather(dwQ, Z, starts_with("dw")) %>%
   filter(!is.na(Z))

dwQDW <- theDW %>%
   gather(dwQ, DW, starts_with("dw"))

dwQ <- demogs %>%
  merge(dwQZ[c("subid","dwQ","Z")], by="subid") %>%
  merge(dwQDW[c("subid","dwQ","DW")], by=c("subid","dwQ"), all.x =TRUE) %>%
  filter(Age > 6, dx != "GAD", !is.na(dx))

dwQ_trio <- subset(dwQ, scanner =="trio" & shell == "single")


# ## transform QC measures to normality ## this should be done separately for trio and prisma
# trio <- subset(demogs, scanner=="trio") %>%
#   mutate("dvars_pT"  = transform_to_normal(dvars_nstd),
#          "tsnr_pT"  = transform_to_normal(tsnr),
#          "fd_pT"  = transform_to_normal(fd_mean))
# 
# # Pricipal Components Analysis
# # entering raw data and extracting PCs
# # from the correlation matrix
# fit_trio <- princomp(dplyr::select(trio, dvars_pT, tsnr_pT, fd_pT) , cor=TRUE)
# summary(fit_trio) # print variance accounted for
# loadings(fit_trio) # pc loadings
# plot(fit_trio,type="lines") # scree plot
# ## write the top 5 principal components to the speadsheet
# trio <- cbind(trio ,fit_trio$scores[ ,1:2]) # the principal components
# 
# ## add Func QC PCs to dfs
# type_trio <- type_trio %>% merge(trio[c("subid","Comp.1", "Comp.2")], by="subid")
# lenQ_trio <- lenQ_trio %>% merge(trio[c("subid","Comp.1", "Comp.2")], by="subid")
# dwQ_trio <- dwQ_trio %>% merge(trio[c("subid","Comp.1", "Comp.2")], by="subid")
# 
# prisma <- subset(demogs, scanner=="prisma") %>%
#   mutate("dvars_pT"  = transform_to_normal(dvars_nstd),
#          "tsnr_pT"  = transform_to_normal(tsnr),
#          "fd_pT"  = transform_to_normal(fd_mean))
# 
# # Pricipal Components Analysis
# # entering raw data and extracting PCs
# # from the correlation matrix
# fit_prisma <- princomp(dplyr::select(prisma, dvars_pT, tsnr_pT, fd_pT) , cor=TRUE)
# summary(fit_prisma) # print variance accounted for
# loadings(fit_prisma) # pc loadings
# plot(fit_prisma,type="lines") # scree plot
# ## write the top 5 principal components to the speadsheet
# prisma <- cbind(prisma ,fit_prisma$scores[ ,1:2]) # the principal components
# 
# ## add Func QC PCs to dfs
# type_prisma <- type_prisma %>% merge(prisma[c("subid","Comp.1", "Comp.2")], by="subid")
# # lenQ_prisma <- lenQ_prisma %>% merge(prisma[c("subid","Comp.1", "Comp.2")], by="subid")
# # dwQ_prisma <- dwQ_prisma %>% merge(prisma[c("subid","Comp.1", "Comp.2")], by="subid")


```

## Sort data COMPULS
```{r, fig.width=12}

comp_typeZ <- comp_theZs %>%
   gather(FCtype, Z, HO, HE, I) %>%
   filter(!is.na(Z))
  
comp_typeDW <- comp_theDW %>%
   gather(FCtype, DW, HO, HE, I)

type_comp <- comp_demogs %>%
  merge(comp_typeZ[c("subid","FCtype","Z")], by="subid") %>%
  merge(comp_typeDW[c("subid","FCtype","DW")], by=c("subid","FCtype"), all.x =TRUE) %>%
  filter(!is.na(dx))


comp_lenQZ <- comp_theZs %>% 
  gather(lenQ, Z, starts_with("len")) %>%
  filter(!is.na(Z))
 
comp_lenQDW <- comp_theDW %>%
   gather(lenQ, DW, starts_with("len")) 

lenQ_comp <- comp_demogs %>%
  merge(comp_lenQZ[c("subid","lenQ","Z")], by="subid") %>%
  merge(comp_lenQDW[c("subid","lenQ","DW")], by=c("subid","lenQ"), all.x =TRUE) %>%
  filter(!is.na(dx))

comp_dwQZ <- comp_theZs %>%
   gather(dwQ, Z, starts_with("dw")) %>%
   filter(!is.na(Z))

comp_dwQDW <- comp_theDW %>%
   gather(dwQ, DW, starts_with("dw"))

dwQ_comp <- comp_demogs %>%
  merge(comp_dwQZ[c("subid","dwQ","Z")], by="subid") %>%
  merge(comp_dwQDW[c("subid","dwQ","DW")], by=c("subid","dwQ"), all.x =TRUE) %>%
  filter(!is.na(dx))


## transform QC measures to normality ## this should be done separately for trio and prisma
# comp <- comp_demogs %>%
#   mutate("dvars_pT"  = transform_to_normal(dvars_nstd),
#          "tsnr_pT"  = transform_to_normal(tsnr),
#          "fd_pT"  = transform_to_normal(fd_mean))
# 
# # Pricipal Components Analysis
# # entering raw data and extracting PCs
# # from the correlation matrix
# fit_comp <- princomp(dplyr::select(comp, dvars_pT, tsnr_pT, fd_pT) , cor=TRUE)
# summary(fit_comp) # print variance accounted for
# loadings(fit_comp) # pc loadings
# plot(fit_comp,type="lines") # scree plot
# ## write the top 5 principal components to the speadsheet
# comp <- cbind(comp, fit_comp$scores[ ,1:2]) # the principal components
# 
# ## add Func QC PCs to dfs
# type_comp <- type_comp %>% merge(comp[c("subid","Comp.1", "Comp.2")], by="subid")
# lenQ_comp <- lenQ_comp %>% merge(comp[c("subid","Comp.1", "Comp.2")], by="subid")
# dwQ_comp <- dwQ_comp %>% merge(comp[c("subid","Comp.1", "Comp.2")], by="subid")

```

## statistics! Does tract type predict connectivity strength?
```{r FC_dx}

################### Does tract type predict FC strength? #########
## TRIO
print(paste("Anova - Does tract type predict FC strength?- trio"))
F2.trio.Z <- lmer(Z ~ FCtype +dx + sex + Age + fd_mean + (1|subid), 
               data = type_trio)
#summary(F2.trio.Z)
print(Anova(F2.trio.Z))
# summary(glht(F2.trio.Z, linfct=mcp(dx ="Tukey")))
summary(glht(F2.trio.Z, linfct=mcp(FCtype ="Tukey")))


# plot type X dx 
pltTrioZ <- ggplot(type_trio, aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))

## PRISMA
print(paste("Anova - Does tract type predict FC strength?- prisma"))
F2.prisma.Z <- lmer(Z ~ FCtype +dx +sex + Age + fd_mean + (1|subid), 
               data = type_prisma)
print(Anova(F2.prisma.Z))
summary(glht(F2.prisma.Z, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
pltPrismaZ <- ggplot(type_prisma, aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))

## COMP
print(paste("Anova - Does tract type predict FC strength?- comp"))    #########Age interactions
F2.comp.Z <- lmer(Z ~ FCtype*dx + FCtype*sex + Age + fd_mean + (1|subid), 
               data = type_comp)
print(Anova(F2.comp.Z))
summary(glht(F2.comp.Z, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
pltCompZ <- ggplot(type_comp, aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))

figZ <- plot_grid(pltTrioZ, pltPrismaZ, pltCompZ, align="hv", ncol = 3)
figZ
figZ.file <- paste(outdir, "FC_dx.png", sep="/")
ggsave(figZ.file, figZ, dpi=300, width = 30, height = 8, units = "cm")

```

```{r FC_dx_by-sex}
#TRIO
# type x dx 
print(paste("Anova - Does tract type predict FC strength?- trio"))
F2.trio.Zm <- lmer(Z ~ FCtype*dx + Age + fd_mean + (1|subid), 
               data = filter(type_trio, sex=="Male"))
print(Anova(F2.trio.Zm))

print(paste("Anova - Does tract type predict FC strength?- trio"))
F2.trio.Zf <- lmer(Z ~ FCtype +dx + Age + fd_mean + (1|subid), 
               data = filter(type_trio, sex=="Female"))
print(Anova(F2.trio.Zf))

##figures by sex
figZ_bysex_trio <-ggplot(type_trio, aes(x=FCtype, y=Z, color = dx, fill=sex)) + geom_boxplot(outlier.alpha = 0.5, outlier.size = 1) + 
  scale_fill_manual(values=c("#FFFFFF","#CCCCCC")) +ylim(0.2,0.8) +
  ylab("Functional Connectivity") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
figZ_bysex_trio

##PRISMA
# type x dx 
print(paste("Anova - Does tract type predict FC strength?- prisma"))
F2.prisma.Zm <- lmer(Z ~ FCtype*dx + Age + fd_mean + (1|subid), 
               data = filter(type_prisma, sex=="Male"))
print(Anova(F2.prisma.Zm))

print(paste("Anova - Does tract type predict FC strength?- prisma"))
F2.prisma.Zf <- lmer(Z ~ FCtype*dx + Age + fd_mean + (1|subid), 
               data = filter(type_prisma, sex=="Female"))
print(Anova(F2.prisma.Zf))

##figures by sex
figZ_bysex_prisma <-ggplot(type_prisma, aes(x=FCtype, y=Z, color = dx, fill=sex)) + geom_boxplot(outlier.alpha = 0.5, outlier.size = 1) + 
  scale_fill_manual(values=c("#FFFFFF","#CCCCCC")) +ylim(0.2,0.8) +
  ylab("Functional Connectivity") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
figZ_bysex_prisma

#COMPULS
# type x dx
print(paste("Anova - Does tract type predict FC strength?- comp"))
F2.comp.Zm <- lmer(Z ~ FCtype*dx + Age + fd_mean + (1|subid), 
               data = filter(type_comp, sex=="Male"))
print(Anova(F2.comp.Zm))

print(paste("Anova - Does tract type predict FC strength?- comp"))
F2.comp.Zf <- lmer(Z ~ FCtype*dx + Age + fd_mean + (1|subid), 
               data = filter(type_comp, sex=="Female"))
print(Anova(F2.comp.Zf))

##figures by sex
figZ_bysex_comp <- ggplot(type_comp, aes(x=FCtype, y=Z, color = dx, fill=sex)) + geom_boxplot(outlier.alpha = 0.5, outlier.size = 1) + 
  scale_fill_manual(values=c("#FFFFFF","#CCCCCC")) +ylim(0.2,0.8) +
  ylab("Functional Connectivity") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))
figZ_bysex_comp

figZ_bysex <- plot_grid(figZ_bysex_trio, figZ_bysex_prisma, figZ_bysex_comp, align="hv", ncol = 3)
figZ_bysex

#combine figure
figZ_bysex.file <- paste(outdir, "FC_dxXsex.png", sep="/")
ggsave(figZ_bysex.file, figZ_bysex, dpi=300, width = 30, height = 8, units = "cm")


# plot FC male only

pltTrioZmale <- ggplot(filter(type_trio, sex == "Male"), aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))

pltPrismaZmale <- ggplot(filter(type_prisma, sex == "Male"), aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))

pltCompZmale <- ggplot(filter(type_comp, sex == "Male"), aes(x=FCtype, y=Z, color = dx)) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))

figZmale <- plot_grid(pltTrioZmale, pltPrismaZmale, pltCompZmale, align="hv", ncol = 3)
figZmale
figZmale.file <- paste(outdir, "FC_dx_male.png", sep="/")
ggsave(figZmale.file, figZ, dpi=300, width = 21, height = 8, units = "cm")

```


```{r posthoc}
F2.prisma.Zm_HO <- lm(Z ~ dx + Age + fd_mean, 
               data = filter(type_prisma, sex=="Male", FCtype == "HO"))
print(Anova(F2.prisma.Zm_HO))
TukeyHSD(F2.prisma.Zm_HO, "dx")

F2.prisma.Zm_HE <- lm(Z ~ dx + Age + fd_mean, 
               data = filter(type_prisma, sex=="Male", FCtype == "HE"))
print(Anova(F2.prisma.Zm_HE))
TukeyHSD(F2.prisma.Zm_HE, "dx")

F2.prisma.Zm_I <- lm(Z ~ dx + Age + fd_mean, 
               data = filter(type_prisma, sex=="Male", FCtype == "I"))
print(Anova(F2.prisma.Zm_I))
TukeyHSD(F2.prisma.Zm_I, "dx")


F2.comp.Zm_HO <- lm(Z ~ dx + Age + fd_mean, 
               data = filter(type_comp, sex=="Male", FCtype == "HO"))
print(Anova(F2.comp.Zm_HO))
TukeyHSD(F2.comp.Zm_HO, "dx")

# F2.comp.Zm_HE <- lm(Z ~ dx + Age + fd_mean, 
#                data = filter(type_comp, sex=="Male", FCtype == "HE"))
# print(Anova(F2.comp.Zm_HE))
# TukeyHSD(F2.comp.Zm_HE, "dx")

# F2.comp.Zm_I <- lm(Z ~ dx + Age + fd_mean, 
#                data = filter(type_comp, sex=="Male", FCtype == "I"))
# print(Anova(F2.comp.Zm_I))
# TukeyHSD(F2.comp.Zm_I, "dx")

```

```{r FC-gaf}
##TRIO
print(paste("Anova - Does tract type predict FC strength?- trio - GAF"))
F2.trio.Zgaf <- lmer(Z ~ FCtype + AB21GCCS+ sex + Age + fd_mean + (1|subid),
               data = type_trio)
print(Anova(F2.trio.Zgaf))

print(paste("Anova - Does tract type predict FC strength?- trio - GAF"))
F2.trio.ZgafM <- lmer(Z ~ FCtype + AB21GCCS + Age + fd_mean + (1|subid),
               data = filter(type_trio, sex== "Male"))
print(Anova(F2.trio.ZgafM))

print(paste("Anova - Does tract type predict FC strength?- trio - GAF"))
F2.trio.ZgafF <- lmer(Z ~ FCtype + AB21GCCS + Age + fd_mean + (1|subid),
               data = filter(type_trio, sex== "Female"))
print(Anova(F2.trio.ZgafF))

pltTrioZ_gaf <- ggplot(type_trio, aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + 
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())
pltTrioZ_gaf_M <- ggplot(filter(type_trio, sex== "Male"), aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + 
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())
pltTrioZ_gaf_F <-ggplot(filter(type_trio, sex== "Female"), aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + 
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())

#PRISMA
print(paste("Anova - Does tract type predict FC strength?- prisma - GAF"))
F2.prisma.Zgaf <- lmer(Z ~ FCtype +AB21GCCS +sex + Age + fd_mean + (1|subid),
               data = type_prisma)
print(Anova(F2.prisma.Zgaf))

print(paste("Anova - Does tract type predict FC strength?- prisma - GAF"))
F2.prisma.ZgafM <- lmer(Z ~ FCtype +AB21GCCS + Age + fd_mean + (1|subid),
               data = filter(type_prisma, sex== "Male"))
print(Anova(F2.prisma.ZgafM))

print(paste("Anova - Does tract type predict FC strength?- prisma - GAF"))
F2.prisma.ZgafF <- lmer(Z ~ FCtype + AB21GCCS + Age + fd_mean + (1|subid),
               data = filter(type_prisma, sex== "Female"))
print(Anova(F2.prisma.ZgafF))

pltPrismaZ_gaf <- ggplot(type_prisma, aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + 
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())
pltPrismaZ_gaf_M <- ggplot(filter(type_prisma, sex== "Male"), aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) +
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())
pltPrismaZ_gaf_F <-ggplot(filter(type_prisma, sex== "Female"), aes(x=AB21GCCS, y=Z, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) +
  ylab("Functional Connectivity") + xlab("General Adaptive Functioning") + theme(legend.title = element_blank())

figZ_gaf_all <- plot_grid(pltTrioZ_gaf, pltTrioZ_gaf_M, pltTrioZ_gaf_F, pltPrismaZ_gaf, pltPrismaZ_gaf_M, pltPrismaZ_gaf_F, align="hv", ncol = 3)
figZ_gaf_all
```



```{r FC_TRIO-CBCL-tot}
print(paste("Anova - Does tract type predict FC strength?- trio - CBCL"))
F2.trio.Zcbcl <- lmer(Z ~ FCtype +sex + CB68TPTOT + Age + fd_mean + (1|subid), 
               data = type_trio)
print(Anova(F2.trio.Zcbcl))

print(paste("Anova - Does tract type predict FC strength?- trio - CBCL"))
F2.trio.ZcbclM <- lmer(Z ~ FCtype + CB68TPTOT + Age + fd_mean + (1|subid), 
               data = filter(type_trio, sex== "Male"))
print(Anova(F2.trio.ZcbclM))

print(paste("Anova - Does tract type predict FC strength?- trio - CBCL"))
F2.trio.ZcbclF <- lmer(Z ~ FCtype + CB68TPTOT + Age + fd_mean + (1|subid), 
               data = filter(type_trio, sex== "Female"))
print(Anova(F2.trio.ZcbclF))

pltTrioZ_cbcl <- ggplot(type_trio, aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltTrioZ_cbcl_M <- ggplot(filter(type_trio, sex== "Male"), aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltTrioZ_cbcl_F <-ggplot(filter(type_trio, sex== "Female"), aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())

figTrioZ_cbcl_all <- plot_grid(pltTrioZ_cbcl, pltTrioZ_cbcl_M, pltTrioZ_cbcl_F, align="hv", ncol = 3)
figTrioZ_cbcl_all
```

```{r FC_PRISMA-CBCL-tot}
print(paste("Anova - Does tract type predict FC strength?- prisma - CBCL"))
F2.prisma.Zcbcl <- lmer(Z ~ FCtype +CB68TPTOT +sex + Age + fd_mean + (1|subid), 
               data = type_prisma)
print(Anova(F2.prisma.Zcbcl))

print(paste("Anova - Does tract type predict FC strength?- prisma - CBCL"))
F2.prisma.ZcbclM <- lmer(Z ~ FCtype +CB68TPTOT + Age + fd_mean + (1|subid), 
               data = filter(type_prisma, sex== "Male"))
print(Anova(F2.prisma.ZcbclM))

print(paste("Anova - Does tract type predict FC strength?- prisma - CBCL"))
F2.prisma.ZcbclF <- lmer(Z ~ FCtype + CB68TPTOT + Age + fd_mean + (1|subid), 
               data = filter(type_prisma, sex== "Female"))
print(Anova(F2.prisma.ZcbclF))

pltPrismaZ_cbcl <- ggplot(type_prisma, aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltPrismaZ_cbcl_M <- ggplot(filter(type_prisma, sex== "Male"), aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltPrismaZ_cbcl_F <-ggplot(filter(type_prisma, sex== "Female"), aes(x=CB68TPTOT, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())

figPrismaZ_cbcl_all <- plot_grid(pltPrismaZ_cbcl, pltPrismaZ_cbcl_M, pltPrismaZ_cbcl_F, align="hv", ncol = 3)
figPrismaZ_cbcl_all
```

```{r FC_COMP-CBCL-tot}
print(paste("Anova - Does tract type predict FC strength?- comp - CBCL"))
F2.comp.Zcbcl <- lmer(Z ~ FCtype + sex + CBCL_total + Age + fd_mean + (1|subid), 
               data = type_comp)
print(Anova(F2.comp.Zcbcl))

print(paste("Anova - Does tract type predict FC strength?- comp - CBCL"))
F2.comp.ZcbclM <- lmer(Z ~ FCtype + CBCL_total + Age + fd_mean + (1|subid), 
               data = filter(type_comp, sex== "Male"))
print(Anova(F2.comp.ZcbclM))

print(paste("Anova - Does tract type predict FC strength?- comp - CBCL"))
F2.comp.ZcbclF <- lmer(Z ~ FCtype + CBCL_total + Age + fd_mean + (1|subid), 
               data = filter(type_comp, sex== "Female"))
print(Anova(F2.comp.ZcbclF))

pltCompZ_cbcl <- ggplot(type_comp, aes(x=CBCL_total, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltCompZ_cbcl_M <- ggplot(filter(type_comp, sex== "Male"), aes(x=CBCL_total, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())
pltCompZ_cbcl_F <-ggplot(filter(type_comp, sex== "Female"), aes(x=CBCL_total, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.title = element_blank())

figCompZ_cbcl_all <- plot_grid(pltCompZ_cbcl, pltCompZ_cbcl_M, pltCompZ_cbcl_F, align="hv", ncol = 3)
figCompZ_cbcl_all

#combine figs from trio, prisma and compuls
figZ_cbcl_all <- plot_grid(pltTrioZ_cbcl, pltPrismaZ_cbcl, pltCompZ_cbcl, align="hv", ncol = 3)
figZ_cbcl_all
```
```{r FC_IQ}
print(paste("Anova - Does tract type predict FC strength?- trio - IQ"))
F2.trio.Ziq <- lmer(Z ~ FCtype*FSIQ_any +sex + Age + fd_mean + (1|subid), 
               data = type_trio)
print(Anova(F2.trio.Ziq))

pltTrioZ_iq <- ggplot(type_trio, aes(x=FSIQ_any, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(70,140) +
  ylab("Functional Connectivity") + xlab("IQ") + theme(legend.title = element_blank())

print(paste("Anova - Does tract type predict FC strength?- prisma - IQ"))
F2.prisma.Ziq <- lmer(Z ~ FCtype*FSIQ_any +sex + Age + fd_mean + (1|subid), 
               data = type_prisma)
print(Anova(F2.prisma.Ziq))

pltPrismaZ_iq <- ggplot(type_prisma, aes(x=FSIQ_any, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(70,140) +
  ylab("Functional Connectivity") + xlab("IQ") + theme(legend.title = element_blank())

print(paste("Anova - Does tract type predict FC strength?- comp - IQ"))
F2.comp.Ziq <- lmer(Z ~ FCtype*IQ +sex + Age + fd_mean + (1|subid), 
               data = type_comp)
print(Anova(F2.comp.Ziq))

pltCompZ_iq <- ggplot(type_comp, aes(x=IQ, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(70,140) +
  ylab("Functional Connectivity") + xlab("IQ") + theme(legend.title = element_blank())

figZ_IQ_all <- plot_grid(pltTrioZ_iq, pltPrismaZ_iq, pltCompZ_iq, align="hv", ncol = 3)
figZ_IQ_all
```
```{r FC&DW_PS}
print(paste("Anova - Does tract type predict FC strength?- trio - IQ"))
F2.trio.Zps <- lmer(Z ~ FCtype*WISC_PS +sex + Age + fd_mean + (1|subid), 
               data = type_trio)
print(Anova(F2.trio.Zps))

pltTrioZ_ps <- ggplot(type_trio, aes(x=WISC_PS, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(60,140) +
  ylab("Functional Connectivity") + xlab("Processing Speed") + theme(legend.title = element_blank())

print(paste("Anova - Does tract type predict FC strength?- prisma - IQ"))
F2.prisma.Zps <- lmer(Z ~ FCtype*WISC_PS +sex + Age + fd_mean + (1|subid), 
               data = type_prisma)
print(Anova(F2.prisma.Zps))

pltPrismaZ_ps <- ggplot(type_prisma, aes(x=WISC_PS, y=Z, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(60,140) +
  ylab("Functional Connectivity") + xlab("Processing Speed") + theme(legend.title = element_blank())

#DW
print(paste("Anova - Does tract type predict FC strength?- trio - IQ"))
F2.trio.DWps <- lmer(DW ~ FCtype*WISC_PS +sex + Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
print(Anova(F2.trio.DWps))

pltTrioDW_ps <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=WISC_PS, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.05) + xlim(60,140) +
  ylab("Track Density") + xlab("Processing Speed") + theme(legend.title = element_blank())


# print(paste("Anova - Does tract type predict FC strength?- comp - IQ"))
# F2.comp.Zps <- lmer(Z ~ FCtype*IQ +sex + Age + fd_mean + (1|subid), 
#                data = type_comp)
# print(Anova(F2.comp.Ziq))
# 
# pltCompZ_ps <- ggplot(type_comp, aes(x=IQ, y=Z, color = FCtype)) + 
#   geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0.2,0.8) + xlim(70,140) +
#   ylab("Functional Connectivity") + xlab("IQ") + theme(legend.title = element_blank())

fig_PS_all <- plot_grid(pltTrioZ_ps, pltPrismaZ_ps, pltTrioDW_ps, align="hv", ncol = 2)
fig_PS_all
```





# Does tract type predict structure?
```{r DWI-dx}
##################### Does tract type predict structure? ############################################

## TRIO
# type x dx
print(paste("Anova - Does tract type predict structure? - trio"))
F2.trio.DW <- lmer(DW ~ FCtype*dx*sex*Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
print(Anova(F2.trio.DW))
summary(glht(F2.trio.DW, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
pltTrioDW <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=FCtype, y=DW, color = dx)) + 
  geom_boxplot()+ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
pltTrioDW

## PRISMA
# type x dx
print(paste("Anova - Does tract type predict structure? - prisma"))   #########################   NEED to add PC covariate and filter by clustering if using
F2.prisma.DW <- lmer(DW ~ FCtype*Age +sex*FCtype + dx + (1|subid),
               data = filter(type_prisma, in.ex == "in"))
print(Anova(F2.prisma.DW))
summary(glht(F2.prisma.DW, linfct=mcp(FCtype ="Tukey")))

# plot type X dx
pltPrismaDW <- ggplot(filter(type_prisma, in.ex == "in"), aes(x=FCtype, y=DW, color = dx)) +
  geom_boxplot()+ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
pltPrismaDW

## COMP
# type x dx
print(paste("Anova - Does tract type predict structure? - comp"))
F2.comp.DW <- lmer(DW ~ FCtype*sex + Age + dx  + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type_comp, QC_clust != 2, exclude == "in"))
print(Anova(F2.comp.DW))
summary(glht(F2.comp.DW, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
pltCompDW <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in", !is.na(DW)), aes(x=FCtype, y=DW, color = dx)) + 
  geom_boxplot()+ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.position = "none") +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))
pltCompDW

figDW <- plot_grid(pltTrioDW, pltPrismaDW, pltCompDW, align="hv", ncol = 3)
#figDW <- plot_grid(pltTrioDW, pltPrismaDW, NULL, align="hv", ncol = 3)
figDW
figDW.file <- paste(outdir, "DW_dx.png", sep="/")
ggsave(figDW.file, figDW, dpi=300, width = 30, height = 8, units = "cm")

```

```{r DWI-dx-sex}
#TRIO
# type x dx (Male only)
print(paste("Anova - Does tract type predict structure? - trio"))
F2.trio.DWm <- lmer(DW ~ FCtype*dx*Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex == "Male"))
print(Anova(F2.trio.DWm))

# type x dx (female only)
print(paste("Anova - Does tract type predict structure? - trio"))
F2.trio.DWf <- lmer(DW ~ FCtype*dx*Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex == "Female"))
print(Anova(F2.trio.DWf))

##figures by sex
figDW_bysex_trio <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=FCtype, y=DW, color = dx, fill=sex)) + geom_boxplot(outlier.alpha = 0.5, outlier.size = 1) + 
  scale_fill_manual(values=c("#FFFFFF","#CCCCCC")) +ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.title = element_blank()) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
figDW_bysex_trio

#COMP
# type x dx (Male only)
print(paste("Anova - Does tract type predict structure? - comp"))
F2.comp.DWm <- lmer(DW ~ FCtype*dx*Age + Comp.1 + Comp.2 + (1|subid),
               data = filter(type_comp, QC_clust != 2, exclude == "in", sex == "Male"))
print(Anova(F2.comp.DWm))

# type x dx (female only)
print(paste("Anova - Does tract type predict structure? - comp"))
F2.comp.DWf <- lmer(DW ~ FCtype*dx*Age + Comp.1 + Comp.2 + (1|subid),
               data = filter(type_comp, QC_clust != 2, exclude == "in", sex == "Female"))
print(Anova(F2.comp.DWf))

##figures by sex
figDW_bysex_comp <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in"), aes(x=FCtype, y=DW, color = dx, fill=sex)) + geom_boxplot(outlier.alpha = 0.5, outlier.size = 1) +
  scale_fill_manual(values=c("#FFFFFF","#CCCCCC")) +ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.title = element_blank()) +
  scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF", "#000066"))
figDW_bysex_comp


#combine DW figures
figDW_bysex <- plot_grid(figDW_bysex_trio, figDW_bysex_comp, align="hv", ncol = 2)
figDW_bysex
figDW_bysex.file <- paste(outdir, "DW_dxXsex.png", sep="/")
ggsave(figDW_bysex.file, figDW_bysex, dpi=300, width = 21, height = 10, units = "cm")

```

```{r TRIO-DWI-gaf}
print(paste("Anova - Does tract type predict structure? - trio - GAF"))
F2.trio.DWgaf <- lmer(DW ~ FCtype*AB21GCCS + FCtype*sex + Age + PC1 + (1|subid),
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
#summary(F2)
print(Anova(F2.trio.DWgaf))

print(paste("Anova - Does tract type predict structure? - trio - GAF"))
F2.trio.DWgafM <- lmer(DW ~ FCtype*AB21GCCS + Age + PC1+ (1|subid),
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex == "Male"))
print(Anova(F2.trio.DWgafM))

print(paste("Anova - Does tract type predict structure? - trio - GAF"))
F2.trio.DWgafF <- lmer(DW ~ FCtype*AB21GCCS + Age + PC1 + (1|subid),
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex == "Female"))
print(Anova(F2.trio.DWgafF))


pltTrioDW_gaf <-ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=AB21GCCS, y=DW, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04)
pltTrioDW_gaf_male <-ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex =="Male"), aes(x=AB21GCCS, y=DW, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04)
pltTrioDW_gaf_female <-ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex =="Female"), aes(x=AB21GCCS, y=DW, color = FCtype)) +
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04)

figDW_gaf <- plot_grid(pltTrioDW_gaf, pltTrioDW_gaf_male, pltTrioDW_gaf_female, align="hv", ncol=3)
figDW_gaf
```

```{r DW_TRIO-CBCL-tot}
print(paste("Anova - Does tract type predict DW strength?- trio - CBCL"))
F2.trio.DWZcbcl <- lmer(DW ~ sex*FCtype*CB68TPTOT + Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
print(Anova(F2.trio.DWZcbcl))

print(paste("Anova - Does tract type predict DW strength?- trio - CBCL"))
F2.trio.DWcbclM <- lmer(DW ~ FCtype*CB68TPTOT + Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex== "Male"))
print(Anova(F2.trio.DWcbclM))

print(paste("Anova - Does tract type predict DW strength?- trio - CBCL"))
F2.trio.DWcbclF <- lmer(DW ~ FCtype*CB68TPTOT + Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex== "Female"))
print(Anova(F2.trio.DWcbclF))

pltTrioDW_cbcl <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=CB68TPTOT, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())
pltTrioDW_cbcl_M <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex== "Male"), aes(x=CB68TPTOT, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())
pltTrioDW_cbcl_F <-ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in", sex== "Female"), aes(x=CB68TPTOT, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())

figTrioDW_cbcl_all <- plot_grid(pltTrioDW_cbcl, pltTrioDW_cbcl_M, pltTrioDW_cbcl_F, align="hv", ncol = 3)
figTrioDW_cbcl_all
```


```{r DW_COMP-CBCL-tot}
print(paste("Anova - Does tract type predict DW strength?- comp - CBCL"))
F2.comp.DWZcbcl <- lmer(DW ~ sex*FCtype*CBCL_total + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type_comp, QC_clust != 2, exclude == "in"))
print(Anova(F2.comp.DWZcbcl))

print(paste("Anova - Does tract type predict DW strength?- comp - CBCL"))
F2.comp.DWcbclM <- lmer(DW ~ FCtype*CBCL_total + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type_comp, QC_clust != 2, exclude == "in", sex== "Male"))
print(Anova(F2.comp.DWcbclM))

print(paste("Anova - Does tract type predict DW strength?- comp - CBCL"))
F2.comp.DWcbclF <- lmer(DW ~ FCtype*CBCL_total + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type_comp, QC_clust != 2, exclude == "in", sex== "Female"))
print(Anova(F2.comp.DWcbclF))

pltCompDW_cbcl <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in"), aes(x=CBCL_total, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())
pltCompDW_cbcl_M <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in", sex== "Male"), aes(x=CBCL_total, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())
pltCompDW_cbcl_F <-ggplot(filter(type_comp, QC_clust != 2, exclude == "in", sex== "Female"), aes(x=CBCL_total, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.title = element_blank())

figCompDW_cbcl_all <- plot_grid(pltCompDW_cbcl, pltCompDW_cbcl_M, pltCompDW_cbcl_F, align="hv", ncol = 3)
figCompDW_cbcl_all



```
#graph
```{r}

#combine FC and DWI figures
#fig_bysex <- plot_grid(figZ_bysex_trio, figZ_bysex_comp, figDW_bysex_trio, figDW_bysex_comp, align="hv", ncol = 2)
fig_bysex <- plot_grid(figZ_bysex_trio, figZ_bysex_prisma, figZ_bysex_comp, figDW_bysex_trio, NULL, figDW_bysex_comp, align="hv", ncol = 3)


fig_bysex.file <- paste(outdir, "FC_DW_dxXsex.png", sep="/")
ggsave(fig_bysex.file, fig_bysex, dpi=300, width = 21, height = 14, units = "cm")

fig_FC_DW <- plot_grid(pltTrioZ, pltPrismaZ, pltCompZ, pltTrioDW, NULL, pltCompDW, align="hv", ncol = 3)

fig_FC_DW.file <- paste(outdir, "FC_DW_dx.png", sep="/")
ggsave(fig_FC_DW.file, fig_FC_DW, dpi=300, width = 21, height = 14, units = "cm")

# ggplot(filter(tmp, metric %in% c("Z", "DW")), aes(x=AB21GCCS, y=value, color = FCtype)) + 
#   geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +
#   facet_wrap(~metric, scales = "free_y", nrow=2)
# 
# figTz <- ggplot(type_trio, aes(x=AB21GCCS, y=Z, color = FCtype)) + 
#  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) 
# 
# 
# figTdw <- ggplot(type_trio, aes(x=AB21GCCS, y=DW, color = FCtype)) + 
#  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) 
# 
# 
# figGAF <- plot_grid(figTz, figPz, figTdw, figPdw, align="hv", ncol=3)
# 
# figGAF.file <- paste(outdir, "POND.SI_6to18GAF.png", sep="/")
# ggsave(figGAF.file, figGAF, dpi=300, width = 21, height = 18, units = "cm")
# 
# 
# tmp1 <- type_trio
# tmp1$value <- tmp1$Z
# tmp1$metric <- "Z"
# 
# tmp3 <- type_trio
# tmp3$value <- tmp3$DW
# tmp3$metric <- "DW"
# 
# tmp <- rbind(tmp1, tmp3)
# 
# ggplot(filter(tmpP, metric %in% c("Z", "DW")), aes(x=AB21GCCS, y=value, color = FCtype)) + 
#   geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +
#   facet_wrap(~metric, scales = "free_y", nrow=3)


```

```{r plt_CBCL}
#FC
pltTrio_CBCL_sxXtyp_fc <- ggplot(type_trio, aes(x=CB68TPTOT, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.position = "none")

pltPrisma_CBCL_sxXtyp_fc <- ggplot(type_prisma, aes(x=CB68TPTOT, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.position = "none")

pltComp_CBCL_sxXtyp_fc <- ggplot(type_comp, aes(x=CBCL_total, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(0,100) +
  ylab("Functional Connectivity") + xlab("CBCL total") + theme(legend.position = "none")

#DW
pltTrio_CBCL_sxXtyp_dw <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=CB68TPTOT, y=DW, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.position = "none")

pltComp_CBCL_sxXtyp_dw <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in"), aes(x=CBCL_total, y=DW, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0,0.04) + xlim(0,100) +
  ylab("Track Density") + xlab("CBCL total") + theme(legend.position = "none")



figCBCL_sxXtyp <- plot_grid(pltTrio_CBCL_sxXtyp_fc, pltPrisma_CBCL_sxXtyp_fc, pltComp_CBCL_sxXtyp_fc,
                            pltTrio_CBCL_sxXtyp_dw, NULL, pltComp_CBCL_sxXtyp_dw, align="hv", ncol = 3)
figCBCL_sxXtyp
figCBCL_sxXtyp.file <- paste(outdir, "CBCL_sxXtyp.png", sep="/")
ggsave(figCBCL_sxXtyp.file, figCBCL_sxXtyp, dpi=300, width = 21, height = 14, units = "cm")


```

```{r DWI_IQ}
print(paste("Anova - Does tract type predict DW strength?- trio - IQ"))
F2.trio.DWiq <- lmer(DW ~ FCtype*FSIQ_any +sex + Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
print(Anova(F2.trio.DWiq))

pltTrioDW_iq <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=FSIQ_any, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.05) + xlim(70,140) +
  ylab("Track Density") + xlab("IQ") + theme(legend.title = element_blank())


print(paste("Anova - Does tract type predict DW strength?- comp - IQ"))
F2.comp.DWiq <- lmer(DW ~ FCtype*IQ +sex + Age + Comp.1 +Comp.2 + (1|subid), 
               data = filter(type_comp, QC_clust != 2, exclude == "in"))
print(Anova(F2.comp.DWiq))

pltCompDW_iq <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in"), aes(x=IQ, y=DW, color = FCtype)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +ylim(0,0.05) + xlim(70,140) +
  ylab("Track Density") + xlab("IQ") + theme(legend.title = element_blank())

figDW_IQ_all <- plot_grid(pltTrioDW_iq, pltCompDW_iq, align="hv", ncol =2)
figDW_IQ_all
```

```{r plt_AGE}
#FC
pltTrio_AGE_sxXtyp_fc <- ggplot(type_trio, aes(x=Age, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(6,18) +
  ylab("Functional Connectivity") + xlab("Age") + theme(legend.position = "none")

pltPrisma_AGE_sxXtyp_fc <- ggplot(type_prisma, aes(x=Age, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(6,18) +
  ylab("Functional Connectivity") + xlab("Age") + theme(legend.position = "none")

pltComp_AGE_sxXtyp_fc <- ggplot(type_comp, aes(x=Age, y=Z, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0.2,0.9) + xlim(8,13) +
  ylab("Functional Connectivity") + xlab("Age") + theme(legend.position = "none")

#DW
pltTrio_AGE_sxXtyp_dw <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=Age, y=DW, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0,0.04) + xlim(6,18) +
  ylab("Track Density") + xlab("Age") + theme(legend.position = "none")

pltComp_AGE_sxXtyp_dw <- ggplot(filter(type_comp, QC_clust != 2, exclude == "in"), aes(x=Age, y=DW, color = FCtype, shape = sex)) + 
  geom_jitter(width = 0.3, size = 1, alpha=0.5) +  geom_smooth(aes(linetype = sex), span = 0.5) +ylim(0,0.04) + xlim(8,13) +
  ylab("Track Density") + xlab("Age") + theme(legend.position = "none")



figAGE_sxXtyp <- plot_grid(pltTrio_AGE_sxXtyp_fc, pltPrisma_AGE_sxXtyp_fc, pltComp_AGE_sxXtyp_fc,
                            pltTrio_AGE_sxXtyp_dw, NULL, pltComp_AGE_sxXtyp_dw, align="hv", ncol = 3)
figAGE_sxXtyp
figAGE_sxXtyp.file <- paste(outdir, "AGE_sxXtyp.png", sep="/")
ggsave(figAGE_sxXtyp.file, figAGE_sxXtyp, dpi=300, width = 21, height = 14, units = "cm")


```

## statistics! POND cluster groups from Grace instead of dx
```{r FC_dx}

################### Does tract type predict FC strength? #########
## TRIO
print(paste("Anova - Does tract type predict FC strength?- trio"))
F2.trio.Z <- lmer(Z ~ FCtype*as.factor(cluster_groups) + sex + Age + fd_mean + (1|subid), 
               data = type_trio)
#summary(F2.trio.Z)
print(Anova(F2.trio.Z))
# summary(glht(F2.trio.Z, linfct=mcp(dx ="Tukey")))
summary(glht(F2.trio.Z, linfct=mcp(FCtype ="Tukey")))


# plot type X dx 
pltTrioZ_clust <- ggplot(type_trio, aes(x=FCtype, y=Z, color =as.factor(cluster_groups))) + 
  geom_boxplot() +ylim(0.2,0.8) + theme(legend.position = "none") +
  ylab("Functional Connectivity") + xlab(NULL) #+
  #scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
pltTrioZ_clust

print(paste("Anova - Does tract type predict structure? - trio"))
F2.trio.DW <- lmer(DW ~ FCtype*as.factor(cluster_groups)*sex*Age + PC1 + (1|subid), 
               data = filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"))
print(Anova(F2.trio.DW))
summary(glht(F2.trio.DW, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
pltTrioDW_clust <- ggplot(filter(type_trio, cutree.res.hc..k...3. != 3, in.ex == "in"), aes(x=FCtype, y=DW, color = as.factor(cluster_groups))) + 
  geom_boxplot()+ylim(0,0.05) +
  ylab("Track Density") + xlab(NULL) + theme(legend.position = "none") #+
  #scale_color_manual(values=c("#FF3300", "#66CC33", "#0099FF", "#9900FF"))
pltTrioDW_clust


fig_clust <- plot_grid(pltTrioZ_clust, pltTrioDW_clust, align="hv", ncol = 2)
fig_clust
fig_clust.file <- paste(outdir, "FC_clust.png", sep="/")
ggsave(fig_clust.file, figZ, dpi=300, width = 30, height = 8, units = "cm")

```
