---
title: "func_struct"
author: "nforde"
date: "March 27, 2018"
output: html_document
---

## get libraries/set paths
```{r}
library(igraph)
library(dplyr)
library(tidyr)
library(ggplot2)
library(broom)
library(knitr)
library(car)
library(rmarkdown)
library(lme4)
library(multcomp)

#FC temporal stability
window_size = 30

#diffusion threshold
threshold = 5 #percent threshold value, keeps this percent of connections

## set all the paths
#POND
pond_demographics <- read.csv("/projects/stephanie/DataFiles_CT.DTI.Beh.POND/GlimExtIN_CTROIUF.csv")
qap_functional_temporal <- read.csv("/mnt/tigrlab/projects/edickie/analysis/POND_RST/qap/qap_functional_temporal.csv")
tsdir <- "/scratch/nforde/homotopic/POND/hcp/glasser_meants"
ts_pattern <- "RST_pond42fix"
pond_extra <- read.csv("/scratch/nforde/homotopic/POND/pond_demog.csv")
diffdir <- "/scratch/nforde/homotopic/POND/CSD"
outdir <- "/scratch/nforde/homotopic/POND/edge_metrics"
xyz <- read.csv("/scratch/nforde/homotopic/atlases/xyz.csv")

for (i in 1:nrow(pond_extra)) {
  if (startsWith(as.character(pond_extra$subject[i]), "88")) {
    pond_extra$subject[i] <- paste0("0", pond_extra$subject[i])
  }
}
z <-  strsplit(as.character(pond_demographics$DTI.CT.codes),"-")
pond_demographics$subject <- sapply(z,FUN=function(x){paste0(x[1],x[2])})
demogs <- merge(pond_demographics, pond_extra[c(1,2,7:10,12)], by.x="subject", by.y="subject", all.x=TRUE)
demogs <- demogs[!duplicated(demogs$subject),]

#ABIDE
NYU_tsdir <- "/scratch/nforde/homotopic/ABIDE/hcp/glasser_meants"
NYU_ts_pattern <- "rest_abide25fix"
ABIDE_demogs <- read.csv("/mnt/tigrlab/projects/edickie/analysis/abide_PINT/scripts/ABIDEI_Pheno_QCed_20161010.csv")
NYU_demogs <- filter(ABIDE_demogs, SITE_ID == "NYU")

```
## define functions
```{r}

## for normalising data
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

## to make dataframe that labels connection as I, HE and HO
make_g_template <- function(subid, tsdir, ts_pattern) {
  meants <- read.csv(file.path(tsdir,
                               paste(subid, ts_pattern, "glasser_meants.csv", sep="_")),
                     header=FALSE)  

  roiids <- read.csv(file.path(tsdir,
                               paste(subid, ts_pattern, "glasser_roiids.csv", sep="_")),
                     header=TRUE)  
  
  rois <- as.character(roiids$labelname)
  meants_t <- t(meants)
  colnames(meants_t) <- rois
  
  cormat <- cor(meants_t)
  g<-graph_from_adjacency_matrix(cormat,mode="upper", 
                                 weighted=T, diag=F, 
                                 add.rownames = "code")
  g.df <- as.data.frame(get.edgelist(g), names=T)

  #split ROI names into hemi and name  
  for (i in 1:nrow(g.df)) {
    g.df$V1.hemi[i] = strsplit(as.character(g.df$V1[i]),"_")[[1]][1]
    g.df$V1.roi[i] = strsplit(as.character(g.df$V1[i]),"_")[[1]][2]
    g.df$V2.hemi[i] = strsplit(as.character(g.df$V2[i]),"_")[[1]][1]
    g.df$V2.roi[i] = strsplit(as.character(g.df$V2[i]),"_")[[1]][2]
  }
  
  g.df$FCtype <- NA
  g.df$FCtype[g.df$V1.roi==g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Homotopic"
  g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi!=g.df$V2.hemi] <- "Heterotopic"
  g.df$FCtype[g.df$V1.roi!=g.df$V2.roi & g.df$V1.hemi==g.df$V2.hemi] <- "Intrahemispheric"
  
  V1xyz <- xyz
  V1names <- c("V1x", "V1y", "V1z", "V1roi")
  colnames(V1xyz) <- V1names
  V2xyz <- xyz
  V2names <- c("V2x", "V2y", "V2z", "V2roi")
  colnames(V2xyz) <- V2names
  
  tmpV1 <- merge(g.df, V1xyz, by.x="V1", by.y="V1roi")
  g.df <- merge(tmpV1, V2xyz, by.x="V2", by.y="V2roi")
  
  return(g.df)
  
}

## to calculate temporal stability between pairs of ROIs (gets called by calc_all_stability)
calc_subject_stability <- function(subid, tsdir, ts_pattern, g.df, window_size) {
  meants.file <- file.path(tsdir,
                           paste(subid, ts_pattern, "glasser_meants.csv", sep="_"))
  meants <- read.csv(meants.file, header = F)
 
  roiids <- read.csv(file.path(tsdir,
                               paste(subid, ts_pattern, "glasser_roiids.csv", sep="_")),
                     header=TRUE) 
  
  rois <- as.character(roiids$labelname)
  meants_t <- as.data.frame(t(meants))
  names(meants_t) <- rois  
  sub.df <- g.df[ ,c("V1","V2")]
  sub.df$Stability <- NA
  for (i in 1:nrow(sub.df)) {
    z <- rollapply(meants_t[,c(sub.df$V1[i],sub.df$V2[i])], 
                   window_size,
                   function(x) cor(x[,1],x[,2]), 
                   by.column=FALSE)
    sub.df$Stability[i] <- mean(Acf(z)$acf)
  }
  return(sub.df)
}


## to calculate FC strength (Z-scores), temmp stabiulity and structural connection weight
calc_everything <- function(subids, tsdir, ts_pattern, g.df, window_size, diffdir, threshold) {
  ###########  set up empty dataframes ##################
  theZs <- data.frame("subid" = subids, 
                      "HO" = numeric(length(subids)),
                      "HE" = numeric(length(subids)),
                      "I" = numeric(length(subids)),
                      "lenNA" = numeric(length(subids)),
                      "len1" = numeric(length(subids)),
                      "len2" = numeric(length(subids)),
                      "len3" = numeric(length(subids)),
                      "len4" = numeric(length(subids)),
                      "len5" = numeric(length(subids)),
                      "len6" = numeric(length(subids)),
                      "len7" = numeric(length(subids)),
                      "len8" = numeric(length(subids)),
                      "len9" = numeric(length(subids)),
                      "len10" = numeric(length(subids)),
                      "len11" = numeric(length(subids)),
                      "len12" = numeric(length(subids)),
                      "len13" = numeric(length(subids)),
                      "len14" = numeric(length(subids)),
                      "len15" = numeric(length(subids)),
                      "len16" = numeric(length(subids)),
                      "len17" = numeric(length(subids)),
                      "len18" = numeric(length(subids)),
                      "len19" = numeric(length(subids)),
                      "len20" = numeric(length(subids)),
                      "dwNA" = numeric(length(subids)),
                      "dw1" = numeric(length(subids)),
                      "dw2" = numeric(length(subids)),
                      "dw3" = numeric(length(subids)),
                      "dw4" = numeric(length(subids)),
                      "dw5" = numeric(length(subids)),
                      "dw6" = numeric(length(subids)),
                      "dw7" = numeric(length(subids)),
                      "dw8" = numeric(length(subids)),
                      "dw9" = numeric(length(subids)),
                      "dw10" = numeric(length(subids)),
                      "dw11" = numeric(length(subids)),
                      "dw12" = numeric(length(subids)),
                      "dw13" = numeric(length(subids)),
                      "dw14" = numeric(length(subids)),
                      "dw15" = numeric(length(subids)),
                      "dw16" = numeric(length(subids)),
                      "dw17" = numeric(length(subids)),
                      "dw18" = numeric(length(subids)),
                      "dw19" = numeric(length(subids)),
                      "dw20" = numeric(length(subids)))
  theZs[ ,2:ncol(theZs)] <- numeric(nrow(theZs)*(ncol(theZs)-1))
  
  theTS <- theZs
  theDW <- theZs
  
  ## loop for each subject
  for (i in 1:nrow(theZs)) {
    ################ FC strength ###########################
    ## get the subid from the dataframe and read in the meants
    subid <- theZs$subid[i]
    meants.file <- file.path(tsdir,
                             paste(subid, ts_pattern, "glasser_meants.csv", sep="_"))
     
    if (file.exists(meants.file)) {
      meants <- read.csv(meants.file,header=FALSE)  
      roiids <- read.csv(file.path(tsdir,
                             paste(subid, ts_pattern, "glasser_roiids.csv", sep="_")), header=TRUE)
      names(meants) <- paste0("TR_",1:ncol(meants))
      ## correlate and graph
      cormat <- cor(t(dplyr::select(meants,starts_with("TR_"))))
      g<-graph_from_adjacency_matrix(cormat,mode="upper", 
                                     weighted=T, diag=F)
      # take the egde list as a vector
      thecorrs <- E(g)$weight
      
      # apply the Z transform (so we can do stats)
      theseZ <- atanh(thecorrs)
      edges.Z <- cbind(g.df, theseZ)
      
      ################ FC temporal stability ###########################
      ## look and see if a stability output exists
      stab.file <- file.path(tsdir,
                             paste(subid, ts_pattern, "glasser", window_size, "tempstab.csv", sep="_"))
      if (file.exists(stab.file)) {
        ts.df <- read.csv(stab.file) 
      } else {
        ts.df <- calc_subject_stability(subid, tsdir, ts_pattern, g.df, window_size)
        write.csv(ts.df, stab.file, row.names = F)
      }
      ## merge the ts.df with g.df
      edges.TS <- merge(g.df, ts.df, by=c("V1", "V2"))
      
      ################ DWI connectivity ###########################                    
      diff.file <- file.path(diffdir, subid, "det_connectome.csv")
      len.file <- file.path(diffdir, subid, "det_length_connectome.csv")
      vox.file <- file.path(diffdir, subid, "voxel_count.txt")                    
      if (file.exists(diff.file)) {
        diff <- read.csv(diff.file, sep="", header=FALSE) 
        
        rois <- as.character(roiids$labelname)
        colnames(diff) <- rois
        rownames(diff) <- rois
      
        #can't have 0's for igraph : +1, make graph merge and then -1
        diffplus1 <-diff +1
        diff_g<-graph_from_adjacency_matrix(as.matrix(diffplus1),mode="upper", 
                                      weighted=T, diag=F, add.colnames=T) 
      # take the egde list as a vector
        rawplus1 <- E(diff_g)$weight
        raw <- rawplus1 -1
        edges.dw <- cbind(g.df, raw)
      
        #normalise for number of voxels 
        vox <- read.table(vox.file, sep="", header=FALSE)
        oddvals <- seq(1, ncol(vox), by=2)
        vox_count <- vox[,oddvals] #select voxel number and exclude volume
        t.vox <- t(vox_count)
        voxels <- data.frame(t.vox, rois)
        colnames(voxels) <- c('vox', 'rois')
        
        edges <- edges.dw[c('V1','V2')]
        V1.vox <- merge(edges, voxels, by.x='V1', by.y='rois')
        V2.vox <- merge(edges, voxels, by.x='V2', by.y='rois')
        V1.V2 <- merge(V1.vox, V2.vox, by=c('V1', 'V2'))
        V1.V2$vox.total <- as.numeric(V1.V2$vox.x) + as.numeric(V1.V2$vox.y)
        edges.dw_w <- merge(edges.dw, V1.V2[c(1,2,5)], by=c('V1', 'V2'))
        edges.dw_w$weight <- edges.dw_w$raw / edges.dw_w$vox.total * (sum(edges.dw_w$vox.total)/64620)
        
        #length connectome
        len <- read.csv(len.file, sep="", header=FALSE)
        colnames(len) <- rois
        rownames(len) <- rois
        #can't have 0's for igraph : +1, make graph merge and then -1
        lenplus1 <-len +1
        len_g<-graph_from_adjacency_matrix(as.matrix(lenplus1),mode="upper", 
                                      weighted=T, diag=F, add.colnames=T) 
        #take the egde list as a vector
        lenplus1 <- E(len_g)$weight
        length <- lenplus1 -1
        len.df <- cbind(g.df, length)
        edges.dw_norm <- merge(edges.dw_w, len.df[c(1,2,14)], by=c('V1', 'V2'))
        
        #select nonzero length connections and bin 
        edges.dw_nonzero <- subset(edges.dw_norm, length > 0)
        edges.dw_nonzero <- within(edges.dw_nonzero, len_quant <- as.integer(cut(length, quantile(length, probs=0:20/20), include.lowest=TRUE)))
        edges.dw_nonzero <- within(edges.dw_nonzero, dw_quant <- as.integer(cut(weight, quantile(weight, probs=0:20/20), include.lowest=TRUE)))
        
       #can merge to get full edge list again
        edges.dw_all <- merge(edges.dw_norm, edges.dw_nonzero[c(1,2,18,19)], by=c('V1', 'V2'), all.x=TRUE)
        
        edges.ZTS <- merge(edges.Z, edges.TS, by=c('V1', 'V2', 'V1.hemi', 'V1.roi', 'V2.hemi', 'V2.roi', 'FCtype', 'V1x', 'V1y', 'V1z', 'V2x', 'V2y', 'V2z'), all.x=TRUE)
        edges.all <- merge(edges.ZTS, edges.dw_all, by=c('V1', 'V2', 'V1.hemi', 'V1.roi', 'V2.hemi', 'V2.roi', 'FCtype', 'V1x', 'V1y', 'V1z', 'V2x', 'V2y', 'V2z'), all.x=TRUE)
       
        #threshold by connection weight to remove spurious connections .....%
        #edges_thresh <- subset(edges_wlq, weight > quantile(weight, prob = 1 - percent_threshold/100))
        out.file <- file.path(outdir, paste(subid, "edge_metrics.csv", sep="_"))
        write.csv(edges.all, out.file, row.names = F)
      
        
        theZs$HO[i] <- mean(filter(edges.all, FCtype == "Homotopic")$theseZ)
        theZs$HE[i] <- mean(filter(edges.all, FCtype == "Heterotopic")$theseZ)
        theZs$I[i] <- mean(filter(edges.all, FCtype == "Intrahemispheric")$theseZ)
        theZs$lenNA[i] <- mean(filter(edges.all, is.na(len_quant))$theseZ)
        theZs$len1[i] <- mean(filter(edges.all, len_quant == "1")$theseZ)
        theZs$len2[i] <- mean(filter(edges.all, len_quant == "2")$theseZ)
        theZs$len3[i] <- mean(filter(edges.all, len_quant == "3")$theseZ)
        theZs$len4[i] <- mean(filter(edges.all, len_quant == "4")$theseZ)
        theZs$len5[i] <- mean(filter(edges.all, len_quant == "5")$theseZ)
        theZs$len6[i] <- mean(filter(edges.all, len_quant == "6")$theseZ)
        theZs$len7[i] <- mean(filter(edges.all, len_quant == "7")$theseZ)
        theZs$len8[i] <- mean(filter(edges.all, len_quant == "8")$theseZ)
        theZs$len9[i] <- mean(filter(edges.all, len_quant == "9")$theseZ)
        theZs$len10[i] <- mean(filter(edges.all, len_quant == "10")$theseZ)
        theZs$len11[i] <- mean(filter(edges.all, len_quant == "11")$theseZ)
        theZs$len12[i] <- mean(filter(edges.all, len_quant == "12")$theseZ)
        theZs$len13[i] <- mean(filter(edges.all, len_quant == "13")$theseZ)
        theZs$len14[i] <- mean(filter(edges.all, len_quant == "14")$theseZ)
        theZs$len15[i] <- mean(filter(edges.all, len_quant == "15")$theseZ)
        theZs$len16[i] <- mean(filter(edges.all, len_quant == "16")$theseZ)
        theZs$len17[i] <- mean(filter(edges.all, len_quant == "17")$theseZ)
        theZs$len18[i] <- mean(filter(edges.all, len_quant == "18")$theseZ)
        theZs$len19[i] <- mean(filter(edges.all, len_quant == "19")$theseZ)
        theZs$len20[i] <- mean(filter(edges.all, len_quant == "20")$theseZ) 
        theZs$dwNA[i] <- mean(filter(edges.all, is.na(dw_quant))$theseZ)
        theZs$dw1[i] <- mean(filter(edges.all, dw_quant == "1")$theseZ)
        theZs$dw2[i] <- mean(filter(edges.all, dw_quant == "2")$theseZ)
        theZs$dw3[i] <- mean(filter(edges.all, dw_quant == "3")$theseZ)
        theZs$dw4[i] <- mean(filter(edges.all, dw_quant == "4")$theseZ)
        theZs$dw5[i] <- mean(filter(edges.all, dw_quant == "5")$theseZ)
        theZs$dw6[i] <- mean(filter(edges.all, dw_quant == "6")$theseZ)
        theZs$dw7[i] <- mean(filter(edges.all, dw_quant == "7")$theseZ)
        theZs$dw8[i] <- mean(filter(edges.all, dw_quant == "8")$theseZ)
        theZs$dw9[i] <- mean(filter(edges.all, dw_quant == "9")$theseZ)
        theZs$dw10[i] <- mean(filter(edges.all, dw_quant == "10")$theseZ)
        theZs$dw11[i] <- mean(filter(edges.all, dw_quant == "11")$theseZ)
        theZs$dw12[i] <- mean(filter(edges.all, dw_quant == "12")$theseZ)
        theZs$dw13[i] <- mean(filter(edges.all, dw_quant == "13")$theseZ)
        theZs$dw14[i] <- mean(filter(edges.all, dw_quant == "14")$theseZ)
        theZs$dw15[i] <- mean(filter(edges.all, dw_quant == "15")$theseZ)
        theZs$dw16[i] <- mean(filter(edges.all, dw_quant == "16")$theseZ)
        theZs$dw17[i] <- mean(filter(edges.all, dw_quant == "17")$theseZ)
        theZs$dw18[i] <- mean(filter(edges.all, dw_quant == "18")$theseZ)
        theZs$dw19[i] <- mean(filter(edges.all, dw_quant == "19")$theseZ)
        theZs$dw20[i] <- mean(filter(edges.all, dw_quant == "20")$theseZ) 
        
        theTS$HO[i] <- mean(filter(edges.all, FCtype == "Homotopic")$Stability)
        theTS$HE[i] <- mean(filter(edges.all, FCtype == "Heterotopic")$Stability)
        theTS$I[i] <- mean(filter(edges.all, FCtype == "Intrahemispheric")$Stability)
        theTS$lenNA[i] <- mean(filter(edges.all, is.na(len_quant))$Stability)
        theTS$len1[i] <- mean(filter(edges.all, len_quant == "1")$Stability)
        theTS$len2[i] <- mean(filter(edges.all, len_quant == "2")$Stability)
        theTS$len3[i] <- mean(filter(edges.all, len_quant == "3")$Stability)
        theTS$len4[i] <- mean(filter(edges.all, len_quant == "4")$Stability)
        theTS$len5[i] <- mean(filter(edges.all, len_quant == "5")$Stability)
        theTS$len6[i] <- mean(filter(edges.all, len_quant == "6")$Stability)
        theTS$len7[i] <- mean(filter(edges.all, len_quant == "7")$Stability)
        theTS$len8[i] <- mean(filter(edges.all, len_quant == "8")$Stability)
        theTS$len9[i] <- mean(filter(edges.all, len_quant == "9")$Stability)
        theTS$len10[i] <- mean(filter(edges.all, len_quant == "10")$Stability)
        theTS$len11[i] <- mean(filter(edges.all, len_quant == "11")$Stability)
        theTS$len12[i] <- mean(filter(edges.all, len_quant == "12")$Stability)
        theTS$len13[i] <- mean(filter(edges.all, len_quant == "13")$Stability)
        theTS$len14[i] <- mean(filter(edges.all, len_quant == "14")$Stability)
        theTS$len15[i] <- mean(filter(edges.all, len_quant == "15")$Stability)
        theTS$len16[i] <- mean(filter(edges.all, len_quant == "16")$Stability)
        theTS$len17[i] <- mean(filter(edges.all, len_quant == "17")$Stability)
        theTS$len18[i] <- mean(filter(edges.all, len_quant == "18")$Stability)
        theTS$len19[i] <- mean(filter(edges.all, len_quant == "19")$Stability)
        theTS$len20[i] <- mean(filter(edges.all, len_quant == "20")$Stability) 
        theTS$dwNA[i] <- mean(filter(edges.all, is.na(dw_quant))$Stability)
        theTS$dw1[i] <- mean(filter(edges.all, dw_quant == "1")$Stability)
        theTS$dw2[i] <- mean(filter(edges.all, dw_quant == "2")$Stability)
        theTS$dw3[i] <- mean(filter(edges.all, dw_quant == "3")$Stability)
        theTS$dw4[i] <- mean(filter(edges.all, dw_quant == "4")$Stability)
        theTS$dw5[i] <- mean(filter(edges.all, dw_quant == "5")$Stability)
        theTS$dw6[i] <- mean(filter(edges.all, dw_quant == "6")$Stability)
        theTS$dw7[i] <- mean(filter(edges.all, dw_quant == "7")$Stability)
        theTS$dw8[i] <- mean(filter(edges.all, dw_quant == "8")$Stability)
        theTS$dw9[i] <- mean(filter(edges.all, dw_quant == "9")$Stability)
        theTS$dw10[i] <- mean(filter(edges.all, dw_quant == "10")$Stability)
        theTS$dw11[i] <- mean(filter(edges.all, dw_quant == "11")$Stability)
        theTS$dw12[i] <- mean(filter(edges.all, dw_quant == "12")$Stability)
        theTS$dw13[i] <- mean(filter(edges.all, dw_quant == "13")$Stability)
        theTS$dw14[i] <- mean(filter(edges.all, dw_quant == "14")$Stability)
        theTS$dw15[i] <- mean(filter(edges.all, dw_quant == "15")$Stability)
        theTS$dw16[i] <- mean(filter(edges.all, dw_quant == "16")$Stability)
        theTS$dw17[i] <- mean(filter(edges.all, dw_quant == "17")$Stability)
        theTS$dw18[i] <- mean(filter(edges.all, dw_quant == "18")$Stability)
        theTS$dw19[i] <- mean(filter(edges.all, dw_quant == "19")$Stability)
        theTS$dw20[i] <- mean(filter(edges.all, dw_quant == "20")$Stability) 
        
        theDW$HO[i] <- mean(filter(edges.all, FCtype == "Homotopic")$weight)
        theDW$HE[i] <- mean(filter(edges.all, FCtype == "Heterotopic")$weight)
        theDW$I[i] <- mean(filter(edges.all, FCtype == "Intrahemispheric")$weight)
        theDW$lenNA[i] <- mean(filter(edges.all, is.na(len_quant))$weight)
        theDW$len1[i] <- mean(filter(edges.all, len_quant == "1")$weight)
        theDW$len2[i] <- mean(filter(edges.all, len_quant == "2")$weight)
        theDW$len3[i] <- mean(filter(edges.all, len_quant == "3")$weight)
        theDW$len4[i] <- mean(filter(edges.all, len_quant == "4")$weight)
        theDW$len5[i] <- mean(filter(edges.all, len_quant == "5")$weight)
        theDW$len6[i] <- mean(filter(edges.all, len_quant == "6")$weight)
        theDW$len7[i] <- mean(filter(edges.all, len_quant == "7")$weight)
        theDW$len8[i] <- mean(filter(edges.all, len_quant == "8")$weight)
        theDW$len9[i] <- mean(filter(edges.all, len_quant == "9")$weight)
        theDW$len10[i] <- mean(filter(edges.all, len_quant == "10")$weight)
        theDW$len11[i] <- mean(filter(edges.all, len_quant == "11")$weight)
        theDW$len12[i] <- mean(filter(edges.all, len_quant == "12")$weight)
        theDW$len13[i] <- mean(filter(edges.all, len_quant == "13")$weight)
        theDW$len14[i] <- mean(filter(edges.all, len_quant == "14")$weight)
        theDW$len15[i] <- mean(filter(edges.all, len_quant == "15")$weight)
        theDW$len16[i] <- mean(filter(edges.all, len_quant == "16")$weight)
        theDW$len17[i] <- mean(filter(edges.all, len_quant == "17")$weight)
        theDW$len18[i] <- mean(filter(edges.all, len_quant == "18")$weight)
        theDW$len19[i] <- mean(filter(edges.all, len_quant == "19")$weight)
        theDW$len20[i] <- mean(filter(edges.all, len_quant == "20")$weight) 
        theDW$dwNA[i] <- mean(filter(edges.all, is.na(dw_quant))$weight)
        theDW$dw1[i] <- mean(filter(edges.all, dw_quant == "1")$weight)
        theDW$dw2[i] <- mean(filter(edges.all, dw_quant == "2")$weight)
        theDW$dw3[i] <- mean(filter(edges.all, dw_quant == "3")$weight)
        theDW$dw4[i] <- mean(filter(edges.all, dw_quant == "4")$weight)
        theDW$dw5[i] <- mean(filter(edges.all, dw_quant == "5")$weight)
        theDW$dw6[i] <- mean(filter(edges.all, dw_quant == "6")$weight)
        theDW$dw7[i] <- mean(filter(edges.all, dw_quant == "7")$weight)
        theDW$dw8[i] <- mean(filter(edges.all, dw_quant == "8")$weight)
        theDW$dw9[i] <- mean(filter(edges.all, dw_quant == "9")$weight)
        theDW$dw10[i] <- mean(filter(edges.all, dw_quant == "10")$weight)
        theDW$dw11[i] <- mean(filter(edges.all, dw_quant == "11")$weight)
        theDW$dw12[i] <- mean(filter(edges.all, dw_quant == "12")$weight)
        theDW$dw13[i] <- mean(filter(edges.all, dw_quant == "13")$weight)
        theDW$dw14[i] <- mean(filter(edges.all, dw_quant == "14")$weight)
        theDW$dw15[i] <- mean(filter(edges.all, dw_quant == "15")$weight)
        theDW$dw16[i] <- mean(filter(edges.all, dw_quant == "16")$weight)
        theDW$dw17[i] <- mean(filter(edges.all, dw_quant == "17")$weight)
        theDW$dw18[i] <- mean(filter(edges.all, dw_quant == "18")$weight)
        theDW$dw19[i] <- mean(filter(edges.all, dw_quant == "19")$weight)
        theDW$dw20[i] <- mean(filter(edges.all, dw_quant == "20")$weight) 
        
      } else {
        print(paste(diff.file, "does not exist"))
        theZs[i,5:ncol(theZs)] <- NA
        theTS[i,5:ncol(theTS)] <- NA
        theDW[i,2:ncol(theDW)] <- NA
      
        theZs$HO[i] <- mean(filter(edges.Z, FCtype == "Homotopic")$theseZ)
        theZs$HE[i] <- mean(filter(edges.Z, FCtype == "Heterotopic")$theseZ)
        theZs$I[i] <- mean(filter(edges.Z, FCtype == "Intrahemispheric")$theseZ)
        
        theTS$HO[i] <- mean(filter(edges.TS, FCtype == "Homotopic")$Stability)
        theTS$HE[i] <- mean(filter(edges.TS, FCtype == "Heterotopic")$Stability)
        theTS$I[i] <- mean(filter(edges.TS, FCtype == "Intrahemispheric")$Stability)
      }
    } else {
       print(paste(meants.file, "does not exist"))
       theZs[i,2:ncol(theZs)] <- NA
       theTS[i,2:ncol(theTS)] <- NA
    }
  }
  return(list("theZs"=theZs,"theTS"=theTS,"theDW"=theDW))
}
      
```
## Run POND
```{r}
demogs$subid <- paste0("MR160-",demogs$DTI.CT.codes)
demogs <- merge(demogs, qap_functional_temporal, by.x = "subid", by.y = "subject")
demogs <- filter(demogs, perc_fd < 5)

## transform QC measures to normality
demogs <- demogs %>%
  mutate("dvars_pT"  = transform_to_normal(dvars),
         "m_tsnr_pT"  = transform_to_normal(m_tsnr),
         "mean_fd_pT"  = transform_to_normal(mean_fd),
         "quality_pT" = transform_to_normal(quality))

## Now lets do a PCA on the QAP numbers...
# Pricipal Components Analysis
# entering raw data and extracting PCs
# from the correlation matrix
fit <- princomp(dplyr::select(demogs, dvars_pT, m_tsnr_pT, mean_fd_pT, quality_pT) , cor=TRUE)
summary(fit) # print variance accounted for
loadings(fit) # pc loadings
plot(fit,type="lines") # scree plot
## write the top 5 principal components to the speadsheet
demogs <- cbind(demogs,fit$scores[ ,1:2]) # the principal components

subids <- demogs$subid

g.df <- make_g_template(subids[1], tsdir, ts_pattern)

pond_metrics <- calc_everything(subids, tsdir, ts_pattern, g.df, window_size, diffdir, threshold)

theZs <- pond_metrics$theZs
theTS <- pond_metrics$theTS
theDW <- pond_metrics$theDW
```

## Sort data POND
```{r, fig.width=12}

typeZ <- merge(theZs,demogs,by="subid") %>%
   gather(FCtype, Z, HO, HE, I) %>%
   filter(NDD != "", !is.na(Z))
  
typeTS <- merge(theTS,demogs,by="subid") %>%
   gather(FCtype, TS, HO, HE, I) %>%
   filter(NDD != "", !is.na(TS))
 
typeDW <- merge(theDW,demogs,by="subid") %>%
   gather(FCtype, DW, HO, HE, I) %>%
   filter(NDD != "")
  
type_ <- merge(typeZ[c(1,46:50,162:167,179:186)], typeTS[c(1,185,186)], by=c("subid","FCtype"))  #index numbers may change if QC added
type <- merge(type_, typeDW[c(1,185,186)], by=c("subid","FCtype"), all.x =TRUE) %>%
  filter(Age > 6, Age < 18, NDD != "HC")

lenQZ <- merge(theZs,demogs,by="subid") %>%
   gather(lenQ, Z, starts_with("len")) %>%
   filter(NDD != "", !is.na(Z))
  
lenQTS <- merge(theTS,demogs,by="subid") %>%
   gather(lenQ, TS, starts_with("len")) %>%
   filter(NDD != "", !is.na(TS))
 
lenQDW <- merge(theDW,demogs,by="subid") %>%
   gather(lenQ, DW, starts_with("len")) %>%
   filter(NDD != "")

lenQ_ <- merge(lenQZ[c(1,28:32,144:149,161:168)], lenQTS[c(1,167,168)], by=c("subid","lenQ"))  #index numbers may change if QC added
lenQ  <- merge(lenQ_, lenQDW[c(1,167,168)], by=c("subid","lenQ"), all.x =TRUE) %>%
  filter(Age > 6, Age < 18, NDD != "HC")
 
dwQZ <- merge(theZs,demogs,by="subid") %>%
   gather(dwQ, Z, starts_with("dw")) %>%
   filter(NDD != "", !is.na(Z))
  
dwQTS <- merge(theTS,demogs,by="subid") %>%
   gather(dwQ, TS, starts_with("dw")) %>%
   filter(NDD != "", !is.na(TS))
 
dwQDW <- merge(theDW,demogs,by="subid") %>%
   gather(dwQ, DW, starts_with("dw")) %>%
   filter(NDD != "")

dwQ_ <- merge(dwQZ[c(1,28:32,144:149,161:168)], dwQTS[c(1,167,168)], by=c("subid","dwQ"))  #index numbers may change if QC added
dwQ  <- merge(dwQ_, dwQDW[c(1,167,168)], by=c("subid","dwQ"), all.x =TRUE) %>%
  filter(Age > 6, Age < 18, NDD != "HC")

```


## statistics! Does tract type predict connectivity?
```{r, fig.width=12}

################### Does tract type predict FC strength? ##################################
# type x dx
print(paste("Anova - Does tract type predict FC strength?"))
F2 <- lmer(Z ~ FCtype*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = type)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
ggplot(type, aes(x=FCtype, y=Z, color = NDD)) + 
  geom_boxplot() 

# type x dx (male only)
print(paste("Anova Table for type X NDD, male only"))
F2 <- lmer(Z ~ FCtype*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))
         
# plot type X dx (male only)
ggplot(filter(type, sex == "Male"), aes(x=FCtype, y=Z, color = NDD)) + 
  geom_boxplot() 


##################### Does tract type predict FC stability? ############################################
# type x dx
print(paste("Anova - Does tract type predict FC stability?"))
F2 <- lmer(TS ~ FCtype*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = type)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
ggplot(type, aes(x=FCtype, y=TS, color = NDD)) + 
  geom_boxplot() 

# type x dx (male only)
print(paste("Anova Table for type X NDD, male only"))
F2 <- lmer(TS ~ FCtype*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(type, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))
         
# plot type X dx (male only)
ggplot(filter(type, sex == "Male"), aes(x=FCtype, y=TS, color = NDD)) + 
  geom_boxplot() 


##################### Does tract type predict structure? ############################################
# type x dx
print(paste("Anova - Does tract type predict structure?"))
F2 <- lmer(DW ~ FCtype*NDD + Age + sex + (1|subid), 
               data = type)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))

# plot type X dx 
ggplot(type, aes(x=FCtype, y=DW, color = NDD)) + 
  geom_boxplot() 

# type x dx (male only)
print(paste("Anova Table for type X NDD, male only"))
F2 <- lmer(DW ~ FCtype*NDD + Age + (1|subid), 
               data = filter(type, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
summary(glht(F2, linfct=mcp(FCtype ="Tukey")))
         
# plot type X dx (male only)
ggplot(filter(type, sex == "Male"), aes(x=FCtype, y=DW, color = NDD)) + 
  geom_boxplot() 


```
## statistics! Does tract length predict connectivity?
```{r, fig.width=12}

lenQ$lenQordered <- factor(lenQ$lenQ, c('len1','len2','len3','len4','len5','len6','len7','len8','len9','len10','len11','len12','len13','len14','len15','len16','len17','len18','len19','len20'))
lenQ$lenQorderedNA <- factor(lenQ$lenQ, c('lenNA','len1','len2','len3','len4','len5','len6','len7','len8','len9','len10','len11','len12','len13','len14','len15','len16','len17','len18','len19','len20'))

################### Does tract length predict FC strength? ##################################
# length x dx
print(paste("Anova - Does tract length predict FC strength?"))
F2 <- lmer(Z ~ lenQ*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = lenQ)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))

# plot lenQ X dx 
ggplot(lenQ, aes(x=lenQorderedNA, y=Z, color = NDD)) + 
  geom_boxplot() 

ggplot(lenQ,aes(x=as.numeric(factor(lenQordered)), y=Z , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

# lenQ x dx (male only)
print(paste("Anova Table for lenQ X NDD, male only"))
F2 <- lmer(Z ~ lenQ*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(lenQ, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))
         
# plot lenQ X dx (male only)
ggplot(filter(lenQ, sex == "Male"), aes(x=lenQorderedNA, y=Z, color = NDD)) + 
  geom_boxplot() 

ggplot(filter(lenQ, sex == "Male"),aes(x=as.numeric(factor(lenQordered)), y=Z , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

################### Does tract length predict FC stability? ##################################
# length x dx
print(paste("Anova - Does tract length predict FC stability?"))
F2 <- lmer(TS ~ lenQ*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = lenQ)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))

# plot lenQ X dx 
ggplot(lenQ, aes(x=lenQorderedNA, y=TS, color = NDD)) + 
  geom_boxplot() 

ggplot(lenQ,aes(x=as.numeric(factor(lenQordered)), y=TS , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

# lenQ x dx (male only)
print(paste("Anova Table for lenQ X NDD, male only"))
F2 <- lmer(TS ~ lenQ*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(lenQ, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))
         
# plot lenQ X dx (male only)
ggplot(filter(lenQ, sex == "Male"), aes(x=lenQorderedNA, y=TS, color = NDD)) + 
  geom_boxplot() 

ggplot(filter(lenQ, sex == "Male"),aes(x=as.numeric(factor(lenQordered)), y=TS , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

################### Does tract length predict structural weight? ##################################
# length x dx
print(paste("Anova - Does tract length predict FC stability?"))
F2 <- lmer(DW ~ lenQ*NDD + Age + sex + (1|subid), 
               data = lenQ)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))

# plot lenQ X dx 
ggplot(lenQ, aes(x=lenQorderedNA, y=DW, color = NDD)) + 
  geom_boxplot() 

ggplot(lenQ,aes(x=as.numeric(factor(lenQordered)), y=DW , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

# lenQ x dx (male only)
print(paste("Anova Table for lenQ X NDD, male only"))
F2 <- lmer(DW ~ lenQ*NDD + Age + (1|subid), 
               data = filter(lenQ, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(lenQ ="Tukey")))
         
# plot lenQ X dx (male only)
ggplot(filter(lenQ, sex == "Male"), aes(x=lenQorderedNA, y=DW, color = NDD)) + 
  geom_boxplot() 

ggplot(filter(lenQ, sex == "Male"),aes(x=as.numeric(factor(lenQordered)), y=DW , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

```

## statistics! Does tract weight predict FC?
```{r, fig.width=12}

dwQ$dwQordered <- factor(dwQ$dwQ, c('dw1','dw2','dw3','dw4','dw5','dw6','dw7','dw8','dw9','dw10','dw11','dw12','dw13','dw14','dw15','dw16','dw17','dw18','dw19','dw20'))

dwQ$dwQorderedNA <- factor(dwQ$dwQ, c('dwNA','dw1','dw2','dw3','dw4','dw5','dw6','dw7','dw8','dw9','dw10','dw11','dw12','dw13','dw14','dw15','dw16','dw17','dw18','dw19','dw20'))

################### Does tract weight predict FC strength? ##################################
# weight x dx
print(paste("Anova - Does tract weight predict FC strength?"))
F2 <- lmer(Z ~ dwQ*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = dwQ)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(dwQ ="Tukey")))

# plot dwQ X dx 
ggplot(dwQ, aes(x=dwQorderedNA, y=Z, color = NDD)) + 
  geom_boxplot() 

ggplot(dwQ,aes(x=as.numeric(factor(dwQordered)), y=Z , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

# dwQ x dx (male only)
print(paste("Anova Table for dwQ X NDD, male only"))
F2 <- lmer(Z ~ dwQ*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(dwQ, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(dwQ ="Tukey")))
         
# plot dwQ X dx (male only)
ggplot(filter(dwQ, sex == "Male"), aes(x=dwQorderedNA, y=Z, color = NDD)) + 
  geom_boxplot() 

ggplot(filter(dwQ, sex == "Male"),aes(x=as.numeric(factor(dwQordered)), y=Z , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

################### Does tract weight predict FC stability? ##################################
# weight x dx
print(paste("Anova - Does tract weight predict FC stability?"))
F2 <- lmer(TS ~ dwQ*NDD + Age + sex + Comp.1 + Comp.2 + (1|subid), 
               data = dwQ)
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(dwQ ="Tukey")))

# plot dwQ X dx 
ggplot(dwQ, aes(x=dwQorderedNA, y=TS, color = NDD)) + 
  geom_boxplot() 

ggplot(dwQ,aes(x=as.numeric(factor(dwQordered)), y=TS , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

# dwQ x dx (male only)
print(paste("Anova Table for dwQ X NDD, male only"))
F2 <- lmer(TS ~ dwQ*NDD + Age + Comp.1 + Comp.2 + (1|subid), 
               data = filter(dwQ, sex == "Male"))
print(Anova(F2))
summary(glht(F2, linfct=mcp(NDD ="Tukey")))
#summary(glht(F2, linfct=mcp(dwQ ="Tukey")))
         
# plot dwQ X dx (male only)
ggplot(filter(dwQ, sex == "Male"), aes(x=dwQorderedNA, y=TS, color = NDD)) + 
  geom_boxplot() 

ggplot(filter(dwQ, sex == "Male"),aes(x=as.numeric(factor(dwQordered)), y=TS , color = NDD)) + 
  geom_jitter(width = 0.3) + geom_smooth(span = 0.5) 

```

## Combined Plot of strength and stability acros (i) length (ii) weight

```{r, fig.width = 12}

tmp1 <- lenQ
tmp1$value <- tmp1$Z
tmp1$metric <- "Z"

tmp2 <- lenQ
tmp2$value <- tmp2$TS
tmp2$metric <- "TS"

tmp3 <- lenQ
tmp3$value <- tmp3$DW
tmp3$metric <- "DW"

tmp <- rbind(tmp1, tmp2, tmp3)

ggplot(filter(tmp, sex == "Male", metric %in% c("Z", "TS", "DW")), aes(x=as.numeric(factor(lenQordered)), y=value, color = NDD)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +
  facet_wrap(~metric, scales = "free_y", nrow=3)

tmp1 <- dwQ
tmp1$value <- tmp1$Z
tmp1$metric <- "Z"

tmp2 <- dwQ
tmp2$value <- tmp2$TS
tmp2$metric <- "TS"

tmp3 <- dwQ
tmp3$value <- tmp3$DW
tmp3$metric <- "DW"

tmp <- rbind(tmp1, tmp2, tmp3)

ggplot(filter(tmp, sex == "Male", metric %in% c("Z", "TS", "DW")), aes(x=as.numeric(factor(dwQordered)), y=value, color = NDD)) + 
  geom_jitter(width = 0.3) +  geom_smooth(span = 0.5) +
  facet_wrap(~metric, scales = "free_y", nrow=3)

```